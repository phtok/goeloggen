<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Goetheanum Visitenkarten One-Pager</title>
  <style>
    @font-face {
      font-family: "SourceSansPro-Regular";
      src: url("https://goetheanum.ch/build/fonts/SourceSansPro/SourceSansPro-Regular.woff2") format("woff2");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: "SourceSansPro-SemiBold";
      src: url("https://goetheanum.ch/build/fonts/SourceSansPro/SourceSansPro-SemiBold.woff2") format("woff2");
      font-weight: 600;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: "Titillium-Upright";
      src:
        url("assets/fonts/Titillium-LightUpright.otf") format("opentype"),
        local("Titillium Light Upright"),
        local("Titillium-LightUpright"),
        url("https://c.webfontfree.com/Code/WOFF2/6e/08/6e08826f6cea78dcf5936116cf1200f2.woff2") format("woff2");
      font-weight: 300;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: "Titillium-Upright";
      src:
        url("assets/fonts/Titillium-RegularUpright.otf") format("opentype"),
        local("Titillium Upright"),
        local("Titillium Regular Upright"),
        local("Titillium-RegularUpright"),
        url("https://c.webfontfree.com/Code/WOFF2/7d/c7/7dc76275936d0fce6ed97e00d21d0dfe.woff2") format("woff2");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: "Titillium-Upright";
      src:
        url("assets/fonts/Titillium-SemiboldUpright.otf") format("opentype"),
        local("Titillium Semibold Upright"),
        local("Titillium-SemiboldUpright"),
        url("https://c.webfontfree.com/Code/WOFF2/26/16/26163f5a492c5d6c65f89d58ef7e495f.woff2") format("woff2");
      font-weight: 600;
      font-style: normal;
      font-display: swap;
    }

    :root {
      --gci-dark: #37404c;
      --gci-gold: #ebb565;
      --gci-line: #dbe0e4;
      --gci-muted: #a7b2bd;
      --gci-text: #dbe0e4;
      --gci-blue: #005eb8;
      --bg: #36424f;
      --bg2: #37404c;
      --panel: #37404c;
      --panel2: #37404c;
      --line: rgba(219, 224, 228, 0.14);
      --line2: rgba(219, 224, 228, 0.16);
      --text: #dbe0e4;
      --muted: #a7b2bd;
      --accent: #ebb565;
      --accent2: #dbe0e4;
      --card-bg: #ffffff;
      --card-text: #5d5d5d;
      --card-w-mm: 55;
      --card-h-mm: 85;
      --bleed-mm: 3;
      --gci-left-col: clamp(290px, 30vw, 420px);
      --gci-right-col: clamp(300px, 32vw, 420px);
      --gci-stage-max: 420px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      color: var(--text);
      background: var(--bg);
      font-family: "SourceSansPro-Regular", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.32;
      overflow-x: hidden;
    }

    body {
      min-height: 100%;
      display: flex;
      flex-direction: column;
      background: var(--bg);
      color: var(--text);
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: var(--accent);
      z-index: 9999;
    }

    .page-head {
      margin-top: 6px;
      background: #1f2833;
      border: 0;
      border-bottom: 1px solid rgba(219, 224, 228, 0.26);
      border-radius: 0;
      width: 100%;
      margin-left: 0;
      margin-right: 0;
      overflow: hidden;
      box-shadow: none;
      position: sticky;
      top: 6px;
      z-index: 500;
    }

    .page-head-inner {
      width: 100%;
      margin: 0 auto;
      min-height: 92px;
      padding: 18px 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      position: relative;
    }

    .brand-lockup {
      display: flex;
      align-items: center;
      min-width: 0;
    }

    .brand-logo {
      width: auto;
      height: 48px;
      max-width: min(100%, 500px);
      display: block;
      flex: 0 0 auto;
      opacity: 0.98;
    }

    .ui-toggle {
      display: inline-flex;
      border-radius: 0;
      overflow: visible;
      border: 0;
      flex: 0 0 auto;
      gap: 10px;
      white-space: nowrap;
    }

    .ui-toggle button {
      border: none;
      background: transparent;
      color: rgba(219, 224, 228, 0.6);
      min-width: auto;
      padding: 0;
      font-size: 0.7rem;
      font-family: "SourceSansPro-SemiBold", sans-serif;
      font-weight: 700;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      line-height: 1;
      cursor: pointer;
      transition: 0.15s ease;
    }

    .ui-toggle button.on {
      background: transparent;
      color: #fff;
    }

    .ui-toggle button:hover {
      color: #dbe0e4;
    }

    .secret-toggle-header {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 88px;
      height: 30px;
      border: 0;
      background: transparent;
      opacity: 0.01;
      z-index: 40;
      cursor: default;
    }

    .app {
      width: 100%;
      max-width: 100vw;
      margin: 0;
      padding: 0;
      flex: 1;
      min-height: calc(100vh - 98px);
      display: grid;
      grid-template-columns: minmax(290px, var(--gci-left-col)) minmax(0, 1fr);
      grid-template-areas: "controls preview";
      gap: 6px;
      justify-content: stretch;
      align-items: start;
      overflow: visible;
    }

    .panel {
      border: none;
      border-radius: 0;
      background: transparent;
      box-shadow: none;
    }

    .preview {
      grid-area: preview;
      display: grid;
      grid-template-rows: auto auto;
      gap: 1px;
      overflow: visible;
      background: transparent;
      height: auto;
      width: 100%;
      max-width: 100%;
      justify-self: stretch;
      min-width: 0;
      padding: 14px 18px 18px;
      align-content: start;
      justify-items: center;
    }

    .preview-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .owner-mode-state {
      margin-top: 6px;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 6px;
      color: #86d97a;
      font-size: 0.74rem;
      line-height: 1;
      font-family: "SourceSansPro-SemiBold", sans-serif;
      letter-spacing: 0.02em;
    }

    .owner-mode-state.on {
      display: inline-flex;
    }

    .owner-mode-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #59d66c;
      box-shadow:
        0 0 0 1px rgba(19, 54, 26, 0.55),
        0 0 8px rgba(89, 214, 108, 0.75);
      flex: 0 0 auto;
    }

    .email-gate {
      position: fixed;
      inset: 0;
      background: rgba(16, 22, 28, 0.72);
      z-index: 900;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .email-gate.open {
      display: flex;
    }

    .email-gate-dialog {
      width: min(520px, 100%);
      border: 1px solid rgba(219, 224, 228, 0.22);
      border-radius: 9px;
      background: #2f3a46;
      box-shadow: 0 18px 44px rgba(0, 0, 0, 0.34);
      padding: 14px 14px 12px;
      display: grid;
      gap: 10px;
    }

    .email-gate-title {
      font-family: "SourceSansPro-SemiBold", sans-serif;
      color: #eff2f4;
      font-size: 0.98rem;
      letter-spacing: 0.01em;
    }

    .email-gate-copy {
      color: var(--muted);
      font-size: 0.78rem;
      line-height: 1.3;
    }

    .email-gate-line {
      color: #dbe0e4;
      font-size: 0.79rem;
      line-height: 1.2;
    }

    .email-gate-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .email-gate-error {
      min-height: 15px;
      color: #f2a8a8;
      font-size: 0.74rem;
      line-height: 1.2;
    }

    .preview-actions .btn {
      padding: 6px 12px;
      border-radius: 0.4rem;
      font-size: 0.76rem;
      position: relative;
      overflow: visible;
    }

    .preview-actions-break {
      flex-basis: 100%;
      width: 0;
      height: 0;
      margin: 0;
      padding: 0;
    }

    .stage {
      min-height: 0;
      display: grid;
      place-items: center;
      padding: 18px;
      background: #3d4957;
      border: 1px solid rgba(219, 224, 228, 0.2);
      border-radius: 8px;
      margin: 0;
      overflow: hidden;
      box-shadow: none;
      min-width: 0;
      width: min(100%, calc((var(--card-w-mm) * 1mm) + 150px));
      max-width: min(100%, var(--gci-stage-max));
      justify-self: center;
      height: calc((var(--card-h-mm) * 1mm) + 132px);
      max-height: min(78vh, 690px);
    }

    .preview-export {
      width: min(100%, calc((var(--card-w-mm) * 1mm) + 150px));
      max-width: min(100%, var(--gci-stage-max));
      padding: 0;
      display: grid;
      gap: 0;
      justify-items: center;
      justify-self: center;
      margin-top: 8px;
    }

    .export-meta {
      font-size: 0.78rem;
      color: var(--muted);
      text-align: center;
      white-space: normal;
      line-height: 1.28;
      margin-bottom: 7px;
      display: grid;
      gap: 1px;
      justify-items: center;
    }

    .export-meta-line {
      display: block;
      width: 100%;
    }

    .export-format-row {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .export-format-label {
      color: var(--muted);
      font-size: 0.78rem;
      line-height: 1;
      white-space: nowrap;
    }

    .export-format-select {
      width: auto;
      min-width: 116px;
      border: 1px solid rgba(219, 224, 228, 0.24);
      border-radius: 0.35rem;
      padding: 5px 26px 5px 9px;
      color: #f3f5f7;
      background: rgba(255, 255, 255, 0.08);
      font-size: 0.74rem;
      font-family: "SourceSansPro-Regular", sans-serif;
      line-height: 1.15;
    }

    .export-format-select:disabled {
      opacity: 0.55;
      cursor: default;
    }

    .export-crop-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.78rem;
      color: var(--muted);
      line-height: 1.2;
      cursor: pointer;
      width: auto;
    }

    .preview-actions .btn[data-tip]:hover::after {
      content: attr(data-tip);
      position: absolute;
      left: 50%;
      bottom: calc(100% + 8px);
      transform: translateX(-50%);
      background: #1f2731;
      color: #f6f5f1;
      border: 1px solid rgba(219, 224, 228, 0.28);
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 0.65rem;
      line-height: 1.2;
      letter-spacing: 0.01em;
      text-transform: none;
      min-width: 165px;
      max-width: 210px;
      white-space: normal;
      pointer-events: none;
      z-index: 80;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.28);
    }

    .preview-actions .btn[data-tip]:hover::before {
      content: "";
      position: absolute;
      left: 50%;
      bottom: calc(100% + 3px);
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: #1f2731;
      pointer-events: none;
      z-index: 81;
    }

    .preview-zoom {
      transform-origin: center;
      transition: transform 0.15s ease;
    }

    .controls {
      grid-area: controls;
      padding: 16px 16px 20px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 0;
      align-content: start;
      align-items: start;
      background: rgba(24, 32, 41, 0.24);
      min-height: calc(100vh - 98px);
      height: 100%;
      overflow: auto;
      border-right: 1px solid rgba(219, 224, 228, 0.18);
    }

    fieldset {
      border: 1px solid var(--line);
      border-radius: 6px;
      padding: 12px 10px 10px;
      background: rgba(255, 255, 255, 0.04);
      display: grid;
      gap: 9px;
      box-shadow: none;
      margin: 0;
    }

    fieldset + fieldset {
      margin-top: -1px;
    }

    .fieldset-title {
      padding: 0;
      margin: 0 0 3px;
      font-size: 0.69rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--accent2);
      font-family: "SourceSansPro-SemiBold", sans-serif;
      line-height: 1;
    }

    .row {
      display: grid;
      gap: 6px;
    }

    label {
      font-size: 0.7rem;
      letter-spacing: 0.01em;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-height: 17px;
    }

    input,
    select,
    textarea,
    button {
      font: inherit;
    }

    input[type="text"],
    select,
    textarea {
      width: 100%;
      border: none;
      border-radius: 0.3rem;
      padding: 8px 12px;
      font-size: 0.8rem;
      color: #fff;
      background: rgba(255, 255, 255, 0.12);
      font-family: "SourceSansPro-Regular", sans-serif;
    }

    textarea {
      min-height: 68px;
      resize: vertical;
      line-height: 1.3;
    }

    textarea.contact-block {
      min-height: 212px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      box-shadow: 0 0 0 0.2rem rgba(235, 181, 101, 0.28);
    }

    input[type="checkbox"] {
      margin: 0;
    }

    .btn {
      border: none;
      border-radius: 0.45rem;
      background: rgba(255, 255, 255, 0.12);
      color: #fff;
      padding: 7px 12px;
      font-size: 0.74rem;
      font-family: "SourceSansPro-SemiBold", sans-serif;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      cursor: pointer;
      transition: 0.15s ease;
    }

    .btn:hover {
      background: #fff;
      color: #37404c;
    }

    .btn:disabled {
      opacity: 0.58;
      cursor: default;
    }

    .btn.primary {
      background: #fff;
      color: #37404c;
    }

    .business-card {
      width: calc(var(--card-w-mm) * 1mm);
      height: calc(var(--card-h-mm) * 1mm);
      position: relative;
      overflow: hidden;
      background: var(--card-bg);
      box-shadow: 0 0.45px 2px rgba(23, 28, 33, 0.22);
      border-radius: 2px;
      color: var(--card-text);
      font-family: "Titillium-Upright", sans-serif;
      text-rendering: geometricPrecision;
      -webkit-font-smoothing: antialiased;
    }

    #previewCard.business-card {
      box-shadow:
        0 1px 1px rgba(15, 22, 29, 0.18),
        0 10px 24px rgba(15, 22, 29, 0.24);
    }

    .card-svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    .print-sheet {
      display: none;
      width: 210mm;
      min-height: 297mm;
      margin: 0 auto;
      place-items: center;
      padding: 0;
      background: #fff;
    }

    .print-artboard {
      position: relative;
      width: calc(var(--card-w-mm) * 1mm);
      height: calc(var(--card-h-mm) * 1mm);
      display: grid;
      place-items: center;
    }

    .print-artboard.with-crop {
      width: calc((var(--card-w-mm) + (var(--bleed-mm) * 2)) * 1mm);
      height: calc((var(--card-h-mm) + (var(--bleed-mm) * 2)) * 1mm);
      padding: calc(var(--bleed-mm) * 1mm);
    }

    .trim-line {
      position: absolute;
      border: 0.2mm solid rgba(60, 66, 74, 0.4);
      inset: 0;
      pointer-events: none;
    }

    .print-artboard.with-crop .trim-line {
      inset: calc(var(--bleed-mm) * 1mm);
    }

    .crop-mark {
      display: none;
      position: absolute;
      background: #1d2025;
      pointer-events: none;
    }

    .print-artboard.with-crop .crop-mark {
      display: block;
    }

    .crop-mark.h {
      width: 4mm;
      height: 0.25mm;
    }

    .crop-mark.v {
      width: 0.25mm;
      height: 4mm;
    }

    .tlh {
      left: 0;
      top: calc(var(--bleed-mm) * 1mm);
    }

    .trh {
      right: 0;
      top: calc(var(--bleed-mm) * 1mm);
    }

    .blh {
      left: 0;
      bottom: calc(var(--bleed-mm) * 1mm);
    }

    .brh {
      right: 0;
      bottom: calc(var(--bleed-mm) * 1mm);
    }

    .tlv {
      top: 0;
      left: calc(var(--bleed-mm) * 1mm);
    }

    .trv {
      top: 0;
      right: calc(var(--bleed-mm) * 1mm);
    }

    .blv {
      bottom: 0;
      left: calc(var(--bleed-mm) * 1mm);
    }

    .brv {
      bottom: 0;
      right: calc(var(--bleed-mm) * 1mm);
    }

    .footer-note {
      grid-column: 1 / -1;
      border-top: 1px solid rgba(219, 224, 228, 0.16);
      margin-top: 4px;
      padding-top: 8px;
      font-size: 0.74rem;
      color: var(--muted);
      line-height: 1.3;
    }

    @media (max-width: 1260px) {
      .app {
        width: 100%;
        grid-template-columns: minmax(250px, clamp(260px, 34vw, 370px)) minmax(0, 1fr);
      }
    }

    @media (max-width: 980px) {
      .page-head-inner {
        min-height: 82px;
        padding: 14px 14px;
      }

      .brand-logo {
        height: 40px;
        max-width: min(100%, 330px);
      }

      .app {
        width: 100%;
        grid-template-columns: minmax(220px, clamp(228px, 40vw, 338px)) minmax(0, 1fr);
        gap: 4px;
      }

      .controls {
        border-right: 1px solid rgba(219, 224, 228, 0.18);
        overflow: visible;
        padding: 12px 12px 12px;
      }

      .preview {
        padding: 10px 10px 12px;
      }

      .stage,
      .preview-export {
        width: 100%;
        max-width: 100%;
      }

      .stage {
        height: calc((var(--card-h-mm) * 1mm) + 112px);
        max-height: min(74vh, 610px);
        padding: 16px;
      }

    }

    @media (max-width: 620px) {
      .app {
        width: 100%;
        grid-template-columns: 1fr;
        grid-template-areas:
          "preview"
          "controls";
        min-height: auto;
      }

      .controls {
        border-right: 0;
        border-top: 1px solid rgba(219, 224, 228, 0.16);
        min-height: 0;
        height: auto;
      }
    }

    @media (max-width: 700px) {
      .page-head-inner {
        min-height: 72px;
        padding: 10px 10px;
      }

      .brand-logo {
        height: 30px;
        max-width: min(100%, 230px);
      }

      .ui-toggle {
        gap: 8px;
      }

      .ui-toggle button {
        font-size: 0.62rem;
        letter-spacing: 0.07em;
      }

      .preview {
        padding: 10px 10px 12px;
      }

      .stage {
        padding: 16px;
      }

      .preview-actions {
        width: 100%;
        justify-content: center;
      }
    }

    @page {
      size: A4;
      margin: 0;
    }

    @media print {
      body {
        display: block;
        background: #fff;
      }

      body::before {
        display: none;
      }

      .app {
        display: none;
      }

      .page-head {
        display: none;
      }

      .print-sheet {
        display: grid;
      }

      .business-card {
        box-shadow: none;
        border-radius: 0;
      }

      .trim-line {
        border-color: rgba(0, 0, 0, 0.48);
      }
    }
  </style>
</head>
<body>
  <header class="page-head">
    <div class="page-head-inner">
      <div class="brand-lockup">
        <img class="brand-logo" src="assets/goe-visiten.svg" alt="Goetheanum Visitenkarten Logo" />
      </div>
      <button type="button" class="secret-toggle-header" id="ownerModeSwitch" aria-label="Owner Mode"></button>
      <div class="ui-toggle" id="uiLangToggle" role="group" aria-label="Sprache / Language">
        <button type="button" data-uilang="de" class="on">DE</button>
        <button type="button" data-uilang="en">EN</button>
      </div>
    </div>
  </header>

  <main class="app">
    <section class="panel controls">
      <fieldset>
        <div class="fieldset-title" id="fsEntityTitle">Entität</div>
        <div class="row">
          <label for="orgCategory" id="lblOrgCategory">Kategorie</label>
          <select id="orgCategory">
            <option value="hochschule" id="optCatHochschule">Hochschule</option>
            <option value="gesellschaft" id="optCatGesellschaft">Gesellschaft</option>
            <option value="bereiche" id="optCatBereiche">Bereiche</option>
          </select>
        </div>

        <div class="row">
          <label for="schema" id="lblSchema">Einheit / Sektion / Bereich</label>
          <select id="schema">
            <option value="gesellschaft">Allgemeine Anthroposophische Gesellschaft</option>
          </select>
        </div>
      </fieldset>

      <fieldset>
        <div class="fieldset-title" id="fsPersonTitle">Person</div>
        <div class="row">
          <label for="fullName" id="lblFullName">Name</label>
          <input id="fullName" type="text" placeholder="Vorname Nachname" />
        </div>

        <div class="row">
          <label for="roleBlock" id="lblRoleBlock">Funktion / Organisation</label>
          <textarea id="roleBlock" placeholder="Vorstand der Allgemeinen&#10;Anthroposophischen Gesellschaft&#10;Freie Hochschule für Geisteswissenschaft"></textarea>
        </div>

        <div class="row">
          <label for="roleBlockEn" id="lblRoleBlockEn">Englische Übersetzung</label>
          <textarea id="roleBlockEn" placeholder="Executive Council Member of the&#10;General Anthroposophical Society"></textarea>
        </div>
      </fieldset>

      <fieldset>
        <div class="fieldset-title" id="fsContactTitle">Kontakt</div>
        <div class="row">
          <textarea id="contactBlock" class="contact-block" placeholder="Hügelweg 59 · 4143 Dornach&#10;Telefon +41 61 706 4X XX&#10;name@goetheanum.ch&#10;www.goetheanum.ch"></textarea>
        </div>
      </fieldset>
    </section>

    <section class="panel preview">
      <div class="stage">
        <div class="preview-zoom" id="previewZoom">
          <article class="business-card" id="previewCard" aria-label="Visitenkarten-Vorschau"></article>
        </div>
      </div>

      <div class="preview-export">
        <div class="export-meta" id="meta">
          <span class="export-meta-line" id="metaLine1">55 × 85 mm · Einheit</span>
          <label class="export-meta-line export-format-row">
            <span class="export-format-label" id="formatLabel">Format</span>
            <select id="cardFormat" class="export-format-select">
              <option value="portrait" id="optFormatPortrait">Hochformat</option>
              <option value="landscape" id="optFormatLandscape">Querformat</option>
            </select>
          </label>
          <label class="export-meta-line export-crop-toggle"><input type="checkbox" id="includeCrop" checked /><span id="cropLabelText">3 mm Beschnitt + Schnittmarken</span></label>
        </div>
        <div class="preview-actions">
          <button type="button" class="btn" id="btnPdf" data-tip="Einzelkarte als Vektor-PDF ohne Schnittmarken. Für Marken den Druckbogen verwenden.">PDF</button>
          <button type="button" class="btn" id="btnSvg" data-tip="Vektor-SVG. Falls verfügbar mit Textpfaden, sonst mit Titillium-Schriftdefinition.">SVG</button>
          <button type="button" class="btn" id="btnPng" data-tip="Rasterbild als Notlösung, Export in 600 dpi für hohe Auflösung.">PNG</button>
          <span class="preview-actions-break" aria-hidden="true"></span>
          <button type="button" class="btn primary" id="btnSheetPdf" data-tip="A4-Druckbogen als Vektor-PDF mit maximaler Anzahl Karten; optional mit Schnittmarken.">Druckbogen</button>
        </div>
        <div class="owner-mode-state" id="ownerModeState" aria-live="polite">
          <span class="owner-mode-dot" aria-hidden="true"></span>
          <span id="ownerModeStateText">Schnell-Download aktiv</span>
        </div>
      </div>
    </section>
  </main>

  <section class="email-gate" id="emailGate" aria-hidden="true">
    <form class="email-gate-dialog" id="emailGateForm">
      <h2 class="email-gate-title" id="emailGateTitle">Datei per E-Mail anfordern</h2>
      <p class="email-gate-copy" id="emailGateCopy">Erlaubt sind nur Empfänger mit @goetheanum.ch.</p>
      <p class="email-gate-line" id="emailGateFormat">Format: PDF</p>
      <div class="row">
        <label for="emailGateAddress" id="emailGateLabel">E-Mail-Adresse</label>
        <input id="emailGateAddress" type="text" inputmode="email" autocomplete="email" placeholder="name@goetheanum.ch" />
      </div>
      <p class="email-gate-error" id="emailGateError"></p>
      <div class="email-gate-actions">
        <button type="button" class="btn" id="emailGateCancel">Abbrechen</button>
        <button type="submit" class="btn primary" id="emailGateSubmit">Anfordern</button>
      </div>
    </form>
  </section>

  <section class="print-sheet" id="printSheet" aria-hidden="true">
    <div class="print-artboard" id="printArtboard">
      <div class="trim-line"></div>
      <span class="crop-mark h tlh"></span>
      <span class="crop-mark h trh"></span>
      <span class="crop-mark h blh"></span>
      <span class="crop-mark h brh"></span>
      <span class="crop-mark v tlv"></span>
      <span class="crop-mark v trv"></span>
      <span class="crop-mark v blv"></span>
      <span class="crop-mark v brv"></span>
      <article class="business-card" id="printCard" aria-label="Druckvorschau"></article>
    </div>
  </section>

  <script src="assets/titillium-outline-glyphs.js"></script>
  <script src="assets/gci-glyphs.js"></script>
  <script>
    (function () {
      "use strict";

      const ICON_SIGN_PATHS = [
        "M5.7224,3.472L15.8254,0v21.07h-6.002l.007-7.74c.003-.501-.086-.969-.242-1.438-.475-1.43-3.866-8.42-3.866-8.42",
        "M5.292,7.1965s3.062,4.895,3.062,6.039l.048,7.834h-3.538l-.022-2.693c-.035-1.633-3.74-6.24-3.74-6.24l4.19-4.94Z",
        "M0,17.9464l2.355-1.673s1.103,1.842,1.201,2.488c.099.646.02,2.309.02,2.309H1.072s.005-.607.008-.876c.007-.476-.144-.883-.375-1.274-.108-.183-.609-.818-.705-.974"
      ];

      const SYMBOL_LIBRARY = {
        icon: {
          viewBox: "0 0 15.8254 21.07",
          paths: ICON_SIGN_PATHS,
          polygons: []
        },
        gesellschaft: {
          viewBox: "0 0 69.9547 117.0563",
          paths: [
            "m11.9371,47.335c1.249.877,3.536,2.795,8.719,2.764,4.493-.026,7.546-1.459,8.268-1.86.722-.402.983-.482,1.064-.08.08.401-2.287,6.433-5.131,9.73-2.121,2.457-5.022,4.145-9.943,9.676-5.822,6.545-8.677,19.292-8.788,19.787-.168.752-.585.627-.626.21-.036-.356.147-10.852,1.666-22.198,2.261-16.905,3.907-18.305,3.947-18.322.452-.186.824.293.824.293",
            "m49.1129,3.3706s1.538-.439,1.978-.605c.44-.164,3.418-.573,5.165.935,1.595,1.374,3.079,1.649,4.232,1.264,1.155-.385,2.502-1.312,2.694-1.264.219.055.604,4.781-2.143,8.133-2.896,3.533-3.695,6.962-4.672,8.078-1.539,1.761-2.694,2.584-5.166,3.628-.545.231-1.434.81-1.979,1.155-.545.345-.549,0-.549,0,0,0,2.693-2.967,3.187-4.122,1.178-2.748-1.594-2.912-1.759-4.122-.214-1.571,2.144-4.561,2.254-6.21.285-4.278-3.037-6.169-3.298-6.43-.219-.22-.164-.22.056-.44",
            "m24.4869,26.7559c-2.858.28-11.907,1.379-13.065,9.432-.659,4.573,3.13,10.917,14.851,9.336,9.995-1.347,25.289-8.517,31.05-13.002,10.465-8.147,12.753-22.999,12.627-27.103-.084-2.76-.295-4.294-.565-4.95-.5-1.222-.592.253-.526.933.075.762.111,4.144-1.353,7.871-2.475,6.298-5.651,14.116-17.661,21.678-10.495,6.607-21.159,8.918-24.825,9.216-6.173.501-5.357-3.259-4.699-3.923,1.21-1.219,2.085-1.136,3.13-1.524,1.195-.446,1.72-1.856,2.352-2.198,1.546-.838,1.656-.424,2.207-.645.907-.362,1.531-1.308,1.712-2.074.203-.857-.256-1.923-.14-2.397.281-1.149,1.107-2.739-.464-3.283-1.233-.427-2.062,2.382-4.631,2.633",
            "m22.5025,37.8472c.769.322,6.309-.249,13.161-3.306,5.288-2.358,7.68-4.791,8.564-6.636.881-1.845.895-4.024.877-4.763-.042-1.629-1.003-2.256-.794-4.26.648-6.225,1.798-5.919,2.003-8.47.21-2.644.377-7.656-5.638-8.116-1.063-.081-3.217,1.254-6.35,3.342-2.179,1.452-4.708,1.598-6.099,1.754-3.893.444-7.019-1.628-13.536,3.469C10.1525,14.4102,2.4915,28.1552.9875,44.8652-.7205,63.8452-.1825,88.0202,2.3665,112.3352c.22,2.098.352,3.39.447,4.063.132.947.586.646.662.467.074-.178-.804-10.504-.733-23.831.084-15.75,1.508-37.182,3.885-46.414,1.397-5.425,2.465-7.185,3.05-9.231,2.249-7.872,2.156-9.804,4.766-12.702,1.427-1.584,3.079-2.612,4.195-2.533,1.009.071,3.707,1.869,7.379.131,1.965-.93,3.084-.674,5.468-4.589.631-1.035,2.617.131,2.665,1.53.06,1.695-.674,2.401-.74,3.356-.093,1.345,1.514,1.613,1.102,4.129-.205,1.258-1.036,5.099-4.786,6.366-.868.293-1.235.197-1.711.592-1.326,1.097-2.356,2.084-3.591,2.675-.961.459-3.514.835-1.922,1.503"
      ],
          polygons: []
        },
        hochschule: {
          viewBox: "0 0 64.988 116.787",
          paths: [],
          polygons: [
            "35.1885 29.4271 34.8425 36.0061 34.2475 39.2571 33.6265 41.4331 29.1725 47.2871 27.9605 48.6711 27.0945 49.7101 26.4025 51.6141 25.1905 55.5961 21.9015 67.5411 14.2855 98.1821 13.4195 99.5671 10.0005 103.6131 8.4425 105.3441 7.8795 105.9721 8.0525 99.3941 8.5715 87.9681 9.0915 81.3901 9.6105 74.9851 10.3025 69.0991 10.9955 64.0791 13.7655 51.4411 15.4965 44.6901 16.3625 41.9201 17.2285 39.6691 18.4395 37.2461 20.3435 34.6491 22.4215 31.7061 24.1525 29.2821 25.3635 27.3781 26.2295 26.3401 27.7875 24.9551 30.9035 22.8771 32.6345 21.8391 34.1935 20.9731 35.7505 20.2811 35.1885 29.4271",
            "48.193 0 47.655 .023 33.584 4.079 18.979 8.743 18.35 9.1 17.657 9.793 11.945 17.583 9.002 21.91 3.982 30.047 1.282 35.781 1.212 40.779 1.038 46.841 .865 51.69 .692 57.751 .346 69.527 0 81.127 .519 116.787 2.251 113.845 3.635 111.421 4.214 109.702 4.674 97.226 5.193 89.262 5.713 82.165 6.578 70.912 8.546 56.48 13.324 39.641 16.147 36.783 18.869 34.374 19.389 33.336 23.214 23.989 33.428 17.374 41.858 12.286 42.551 12.292 44.49 14.813 44.589 15.191 44.321 16.006 43.976 16.351 39.603 21.581 39.252 22.307 39.816 23.988 40.163 25.2 41.453 30.726 41.721 30.913 58.859 27.797 64.988 18.471 64.461 4.986 64.109 4.494 48.193 0"
      ]
        },
        bau: {
          viewBox: "0 0 135.874 138.8979",
          paths: [
            "m123.909,21.5049c-.162.499-.323.776-.859.819-1.933.159-3.861.38-5.79.59-1.548.168-3.092.365-4.64.531-1.399.15-2.802.261-4.201.412-1.776.19-3.55.414-5.327.603-1.413.149-2.83.26-4.245.402-1.275.127-2.548.277-3.823.407-1.125.115-2.252.212-3.377.325-1.323.132-2.645.27-3.967.409-1.063.112-2.126.232-3.189.343-2.02.211-4.04.414-6.06.629-1.384.148-2.766.313-4.15.464-1.792.196-3.585.381-5.377.578-1.472.161-2.941.341-4.412.5-1.338.144-2.677.264-4.015.407-1.322.141-2.655.23-3.959.473-.703.132-1.359.528-2.028.822-2.151.948-4.275,1.962-6.456,2.836-1.193.478-1.469,1.482-1.861,2.489-1.135,2.92-2.292,5.833-3.438,8.75-.251.639-.536,1.269-.724,1.927-.181.633-.581,1.079-1.055,1.47-1.796,1.481-3.611,2.941-5.41,4.419-2.436,2.003-4.869,4.011-7.295,6.026-1.754,1.457-3.513,2.908-5.221,4.417-.291.258-.4.782-.484,1.205-.467,2.381-.893,4.77-1.349,7.153-.451,2.356-.922,4.709-1.381,7.063-.474,2.427-.952,4.854-1.413,7.283-.333,1.756-.616,3.521-.97,5.272-.454,2.243-.964,4.475-1.435,6.716-.368,1.749-.713,3.503-1.067,5.255-.311,1.542-.624,3.085-.93,4.628-.367,1.857-.718,3.717-1.096,5.571-.296,1.45-.619,2.893-.938,4.338-.266,1.208-.553,2.412-.81,3.622-.086.406-.302.61-.804.657.087-.495.16-.953.247-1.409.251-1.32.503-2.639.763-3.958.408-2.066.822-4.132,1.236-6.198.38-1.898.767-3.795,1.142-5.695.291-1.468.561-2.941.853-4.409.474-2.381.966-4.758,1.435-7.139.272-1.378.51-2.763.773-4.143.237-1.244.492-2.484.733-3.727.361-1.859.712-3.721,1.076-5.579.319-1.633.655-3.262.972-4.895.3-1.545.584-3.094.879-4.64.391-2.049.853-4.087,1.151-6.15.146-1.014.888-1.407,1.511-1.95,1.36-1.185,2.744-2.342,4.129-3.497,1.033-.861,2.088-1.695,3.125-2.551,1.143-.944,2.273-1.905,3.415-2.849,1.179-.975,2.372-1.934,3.549-2.91,1.261-1.044,2.552-2.058,3.743-3.177.416-.391.621-1.038.844-1.599,1.109-2.799,2.194-5.607,3.284-8.413.302-.778.593-1.561.935-2.462-.504.206-.909.357-1.303.534-2.68,1.201-5.382,2.358-8.023,3.639-.992.481-1.85,1.243-2.754,1.898-1.461,1.06-2.913,2.131-4.361,3.209-1.459,1.086-2.91,2.184-4.363,3.278-1.456,1.095-2.909,2.192-4.364,3.288-1.834,1.383-3.668,2.767-5.503,4.148-.857.645-1.718,1.282-2.573,1.929-.254.193-.539.318-.777.068-.115-.122-.124-.406-.089-.599.406-2.223.829-4.443,1.249-6.664.314-1.664.641-3.327.945-4.994.298-1.635.558-3.277.863-4.911.472-2.535.974-5.065,1.453-7.6.312-1.648.605-3.299.908-4.949.063-.345.134-.688.193-1.033.058-.344.243-.553.563-.71,3.323-1.621,6.635-3.265,9.958-4.886,3.021-1.473,6.054-2.922,9.078-4.389,2.788-1.352,5.571-2.714,8.356-4.073,2.058-1.004,4.106-2.033,6.183-2.997.375-.174.872-.133,1.31-.116.873.034,1.743.112,2.613.19.279.024.435-.095.53-.33.81-1.997,1.619-3.995,2.451-6.049-.752-.373-1.495-.757-2.256-1.104-.137-.063-.358-.005-.519.055-2.673,1.005-5.341,2.024-8.014,3.031-2.153.812-4.315,1.6-6.466,2.418-3.779,1.437-7.556,2.881-11.329,4.337-2.794,1.077-5.578,2.182-8.37,3.265-2.523.978-5.042,1.966-7.583,2.893-.539.197-.797.455-.943.999-.683,2.539-1.405,5.068-2.121,7.599-.602,2.132-1.23,4.255-1.817,6.391-.772,2.809-1.509,5.628-2.27,8.44-.921,3.403-1.863,6.8-2.774,10.206-.713,2.669-1.445,5.336-2.059,8.028-.221.971-.161,2.014-.167,3.024-.02,2.866.01,5.733-.013,8.6-.016,1.95-.11,3.9-.134,5.851-.032,2.641-.035,5.283-.041,7.925-.007,3.079-.003,6.158-.004,9.238,0,.545.022,1.091-.004,1.635-.076,1.605-.192,3.209-.252,4.814-.047,1.268-.032,2.537-.048,3.805-.02,1.562-.045,3.124-.062,4.685-.031,2.699-.059,5.397-.086,8.096-.059,5.995-.113,11.99-.179,17.985-.014,1.305-.08,2.609-.102,3.914-.009.582-.542.577-.875.921-.052-.803-.127-1.513-.139-2.223-.021-1.322.001-2.646-.008-3.969C.04,130.0799-.001,127.4529,0,124.8269c.001-2.483.038-4.965.068-7.448.026-2.09.076-4.18.092-6.27.016-2.118-.008-4.236.007-6.354.014-1.964.064-3.928.085-5.892.028-2.827.048-5.654.065-8.481.014-2.183.022-4.367.026-6.55.005-2.739-.006-5.479.008-8.218.016-3.289.065-6.578.072-9.867.003-1.876-.021-3.752-.085-5.626-.039-1.167.132-2.285.449-3.403.824-2.896,1.624-5.799,2.416-8.704.605-2.223,1.175-4.455,1.776-6.679.493-1.827,1.017-3.646,1.513-5.472.753-2.771,1.485-5.548,2.241-8.319.354-1.294.751-2.577,1.116-3.869.468-1.659.923-3.323,1.384-4.984.155-.559.333-1.112.466-1.675.103-.436.3-.705.757-.869,2.617-.938,5.223-1.907,7.828-2.877,2.691-1.003,5.375-2.026,8.067-3.027,3.361-1.248,6.724-2.489,10.091-3.721,2.38-.871,4.771-1.711,7.149-2.586,3.155-1.161,6.302-2.342,9.453-3.517.315-.118.62-.272.944-.36.208-.056.47-.092.657-.014.86.357,1.702.759,2.552,1.142.217.098.286.213.182.465-.703,1.708-1.391,3.422-2.076,5.137-.192.482-.357.975-.552,1.513.132.027.243.066.356.072,1.22.071,2.441.128,3.66.207,1.771.114,3.541.249,5.313.365,1.605.104,3.213.18,4.818.297,1.771.128,3.538.303,5.308.432,1.266.092,2.537.125,3.803.215,1.25.089,2.496.23,3.745.324,1.161.088,2.325.136,3.487.215,1.695.116,3.388.247,5.082.364,1.008.07,2.017.13,3.026.189,1.654.096,3.309.17,4.962.284,1.417.099,2.83.25,4.246.362,2.06.164,4.12.315,6.181.468,1.312.097,2.625.175,3.936.285,1.963.164,3.923.361,5.886.518,1.205.096,2.414.136,3.621.212,1.89.118,3.779.235,5.668.369,1.572.111,3.143.243,4.714.37.427.035.854.082,1.311.127-.166.43-.523.436-.89.409-1.572-.116-3.144-.233-4.716-.353-1.555-.119-3.11-.247-4.666-.363-.961-.071-1.923-.123-2.885-.193-1.615-.118-3.23-.25-4.846-.363-1.132-.079-2.267-.125-3.399-.206-1.388-.099-2.773-.225-4.161-.329-1.054-.08-2.109-.135-3.163-.215-1.831-.139-3.659-.298-5.49-.431-1.235-.09-2.473-.148-3.709-.225-1.771-.11-3.542-.227-5.313-.337-1.698-.106-3.398-.193-5.094-.314-1.832-.129-3.66-.294-5.491-.433-1.404-.106-2.81-.188-4.215-.291-1.891-.14-3.781-.295-5.672-.435-1.084-.081-2.171-.136-3.256-.216-1.539-.114-3.077-.248-4.617-.36-1.465-.106-2.932-.205-4.399-.29-2.019-.117-4.04-.195-6.057-.34-.74-.054-1.297.33-1.898.604-1.832.838-3.647,1.715-5.47,2.573-2.772,1.305-5.544,2.609-8.318,3.911-2.062.967-4.13,1.923-6.189,2.895-2.405,1.136-4.802,2.29-7.207,3.425-1.729.815-3.464,1.618-5.202,2.416-.439.202-.575.516-.652.995-.233,1.464-.569,2.91-.847,4.367-.278,1.455-.53,2.915-.799,4.371-.302,1.636-.617,3.269-.912,4.906-.249,1.385-.472,2.774-.714,4.161-.2,1.144-.412,2.286-.617,3.429-.248,1.38-.497,2.759-.74,4.14-.156.886-.302,1.774-.449,2.661-.012.073.005.15.013.315.518-.353.996-.664,1.457-.997,1.675-1.208,3.348-2.42,5.016-3.639,1.702-1.244,3.398-2.496,5.093-3.75,1.574-1.164,3.139-2.341,4.716-3.5,1.726-1.27,3.433-2.569,5.206-3.77.878-.595,1.87-1.031,2.836-1.484,1.816-.851,3.646-1.673,5.479-2.487,2.432-1.079,4.873-2.135,7.308-3.205,1.694-.745,3.369-1.537,5.085-2.224.608-.243,1.311-.266,1.976-.339,1.99-.217,3.981-.412,5.973-.609.685-.068,1.374-.1,2.059-.174,1.274-.138,2.546-.301,3.82-.443,1.382-.154,2.765-.297,4.148-.443.972-.103,1.945-.202,2.917-.304,1.14-.12,2.28-.243,3.42-.362,1.672-.173,3.345-.342,5.018-.515,1.52-.156,3.041-.306,4.559-.476,1.549-.173,3.093-.381,4.642-.548,1.629-.175,3.262-.314,4.892-.48,1.033-.105,2.063-.236,3.096-.345,1.063-.112,2.129-.21,3.193-.319,1.292-.132,2.585-.267,3.877-.404.974-.103,1.946-.209,2.919-.317,1.637-.183,3.272-.375,4.91-.549,1.323-.142,2.648-.259,3.971-.395.577-.06,1.152-.142,1.728-.209.226-.027.454-.042.761-.069",
            "m29.781,24.0811c.166.599-.023.899-.531,1.146-1.551.757-3.064,1.589-4.611,2.355-.522.258-.675.675-.719,1.178-.047.533-.076,1.068-.09,1.603-.068,2.683-.13,5.365-.191,8.048-.012.528.009.559.495.328.909-.434,1.799-.91,2.701-1.36.295-.147.347-.387.351-.684.013-1,.029-1.999.068-2.997.045-1.163.111-2.324.185-3.485.008-.121.102-.299.201-.34.365-.149.75-.252,1.202-.396.024.358.071.7.066,1.042-.023,1.625-.055,3.25-.094,4.874-.014.623-.044,1.246-.094,1.866-.01.124-.115.295-.223.348-1.78.877-3.568,1.739-5.355,2.6-.121.058-.258.085-.389.119-.42.11-.583.003-.585-.42-.008-1.445-.022-2.89,0-4.334.031-2.037.082-4.074.146-6.111.018-.547.089-1.096.185-1.636.031-.178.181-.401.339-.481,1.431-.722,2.873-1.423,4.318-2.117.718-.344,1.448-.663,2.174-.988.136-.061.282-.1.451-.158",
            "m31.128,32.0836h-.045c0,.507-.034,1.017.008,1.521.054.633.204.702.799.477.099-.038.211-.042.312-.076.479-.161.961-.379,1.003-.944.092-1.229.13-2.463.164-3.695.004-.144-.12-.368-.243-.423-.334-.149-1.76.449-1.925.773-.046.09-.069.201-.07.303-.005.688-.003,1.376-.003,2.064m3.492-2.496c-.054,1.284-.107,2.567-.164,3.851-.021.474-.33.764-.716.935-1.018.451-2.051.871-3.083,1.29-.517.21-.75.106-.768-.446-.04-1.187-.011-2.378-.004-3.567.003-.408.068-.819.031-1.222-.094-1.019.364-1.596,1.32-1.895.901-.281,1.777-.642,2.667-.959.352-.126.657.127.677.581.021.476.005.954.005,1.431.011,0,.023.001.035.001",
            "m45.3072,21.4872v1.927c.51-.159.995-.316,1.483-.462.278-.083.558-.164.842-.222.526-.108.691.014.687.562-.004.679-.065,1.359-.08,2.038-.032,1.425-.046,2.85-.077,4.274-.017.761-.176.926-1.003,1.079v-2.224c-.001-1.412-.005-2.825-.001-4.237.001-.405-.258-.42-.531-.342-.351.102-.683.265-1.031.378-.442.143-.364.537-.381.838-.049.89-.04,1.783-.061,2.675-.013.522-.031,1.044-.071,1.563-.008.109-.102.255-.198.304-.295.154-.61.269-.992.431.028-.285.066-.515.07-.745.017-1.166.006-2.333.041-3.499.035-1.194.104-2.387.178-3.579.007-.125.114-.291.223-.353.272-.155.571-.261.902-.406",
            "m75.2434,23.4525c0-.708.001-1.365,0-2.022-.001-.477.008-.954-.009-1.431-.016-.466-.192-.617-.662-.599-.106.004-.21.044-.316.055q-1.035.106-1.061,1.139c-.025.87-.071,1.739-.077,2.609-.004.471-.313.447-.625.465-.319.018-.478-.09-.466-.449.037-1.075.035-2.151.075-3.226.015-.389-.161-.511-.505-.534-1.14-.078-1.191-.031-1.204,1.071-.011.886-.065,1.773-.05,2.659.009.495-.197.664-.652.637-.122-.007-.245.015-.48.032,0-.3-.008-.588.001-.874.038-1.227.088-2.453.117-3.679.007-.325.106-.459.455-.471.977-.037,1.952-.15,2.928-.166,1.028-.016,2.057.055,3.087.071.361.006.452.238.457.512.014.802.006,1.605,0,2.407-.003.369-.025.738-.028,1.106-.005.64-.029.669-.664.688-.091.002-.183,0-.321,0",
            "m37.4677,30.3119c-.123-.679-.083-.763.45-.983.851-.352.861-.352.846-1.271-.006-.385-.067-.77-.113-1.266-.616.252-1.099.468-1.595.646-.311.112-.445.329-.447.622-.01,1.317-.005,2.633-.005,4.087,1.239-.329,2.239-.863,3.283-1.27.269.561.165.887-.366,1.1-1.005.403-2.01.806-3.02,1.196-.66.255-.92.171-.98-.45-.172-1.769-.238-3.546.075-5.31.027-.153.168-.35.306-.41,1.083-.465,2.172-.916,3.272-1.34.55-.212.75-.041.748.55-.003.889-.013,1.778,0,2.668.005.28-.063.44-.348.549-.708.272-1.401.584-2.106.882",
            "m50.8072,24.9634c-.042-.456-.029-.762.448-.867.26-.057.501-.222.734-.366.091-.055.188-.181.194-.281.026-.397.027-.798.017-1.196-.008-.318-.206-.37-.471-.284-.233.075-.468.146-.696.233-.629.239-.75.443-.765,1.134-.02.89-.069,1.781-.09,2.672-.012.503.046.567.526.404.736-.249,1.451-.559,2.176-.842.07-.027.143-.049.238-.081.184.389.145.673-.279.854-.927.394-1.845.812-2.777,1.194-.547.224-.845.048-.86-.531-.036-1.328-.027-2.657-.046-3.985-.013-.904.635-1.229,1.32-1.49.712-.273,1.443-.497,2.169-.73.335-.107.557.009.552.386-.012.859-.028,1.718-.072,2.575-.006.126-.149.3-.271.355-.656.291-1.324.551-2.047.846",
            "m56.5103,21.3528c.171.49.132.733-.342.848-.321.078-.789.259-.866.498-.176.551-.163,1.165-.195,1.755-.003.054.231.186.338.17.346-.051.681-.172,1.025-.233.414-.074.537-.349.551-.714.035-.952.072-1.905.094-2.858.012-.5-.157-.62-.657-.464-.627.196-1.247.415-1.87.623-.072.024-.147.039-.221.057-.24-.367-.202-.648.172-.782.932-.336,1.871-.658,2.822-.935.513-.149.872.158.881.768.013.898-.04,1.798-.075,2.697-.02.489-.065.977-.093,1.465-.014.244-.066.425-.352.502-1.078.287-2.149.601-3.224.898-.27.074-.455.004-.453-.326.004-.777-.01-1.554.008-2.33.01-.483.226-.849.711-1.018.582-.202,1.162-.413,1.746-.621",
            "m59.079,24.4774v-5.366c1.195,0,2.279-.003,3.363.001.472.002.647.321.664.722.032.706.043,1.414.03,2.12-.013.657-.067,1.313-.106,1.969-.022.364-.248.483-.801.469-.363-.009-.269-.271-.272-.464-.019-1.179-.025-2.359-.041-3.538-.007-.529-.083-.597-.625-.606-.046-.001-.092,0-.139,0-.74-.001-.789.06-.804.82-.023,1.164-.07,2.328-.087,3.492-.003.264-.117.367-.345.378-.26.013-.52.003-.837.003",
            "m67.3812,18.9383h.918c0,.605.018,1.2-.004,1.792-.033.903-.11,1.803-.131,2.706-.008.353-.115.492-.473.507-1.009.044-2.016.126-3.025.175-.452.022-.624-.257-.615-.675.031-1.368.055-2.736.109-4.103.005-.129.181-.333.306-.358.272-.055.562-.017.911-.017-.064,1.177-.114,2.288-.188,3.398-.077,1.149-.014,1.212,1.145,1.019.09-.015.184-.003.276-.009.394-.027.584-.196.595-.634.032-1.251.112-2.502.176-3.801",
            "m41.3393,31.1903v-5.219c-.213.013-.422.025-.65.039-.105-.445-.064-.798.475-.981.524-.179.251-.724.401-1.083.094-.224-.042-.609.096-.736.263-.242.648-.351,1.089-.567v1.675c.296-.044.513-.076.751-.112v.832c-.035.029-.054.058-.08.066-.795.233-.802.232-.818,1.06-.013.69.005,1.381-.011,2.072-.016.704-.04,1.409-.095,2.111-.012.156-.135.354-.267.437-.26.164-.562.262-.891.406",
            "m82.1315,17.9234v.008c-.092,0-.184.004-.277-.001-.612-.034-.607-.031-.62.588-.01.474-.059.946-.068,1.419-.014.734-.023,1.469.002,2.202.004.099.211.244.345.274.181.041.382-.018.574-.018q1.026-.004,1.026-1.037c0-.093-.009-.186.001-.277.048-.409-.169-.642-.526-.755-.201-.063-.422-.06-.628-.109-.118-.028-.225-.101-.337-.154.081-.134.135-.304.251-.391.095-.071.263-.055.399-.059.975-.031,1.037-.12.947-1.08-.041-.45-.247-.629-.674-.611-.138.006-.277.001-.415.001m1.253,2.198c.8.721.316,1.643.307,2.49-.001.128-.389.341-.612.362-.759.074-1.524.074-2.286.113-.337.018-.478-.127-.469-.458.042-1.527.073-3.054.124-4.581.007-.208.012-.473.354-.474.869-.002,1.739-.025,2.608-.014.125.002.345.129.356.219.064.536.128,1.083.089,1.618-.018.233-.282.448-.471.725",
            "m37.7064,19.5449c-.624.131-1.221.302-1.469.819-.304.635-.423,1.359-.623,2.045.049.025.097.051.145.076.632-.302,1.266-.598,1.891-.912.096-.048.216-.184.211-.273-.032-.56-.095-1.119-.155-1.755m.137,2.482c-.593.272-1.125.492-1.634.757-.568.295-.98.713-1.028,1.414-.012.174-.193.337-.297.504-.058-.019-.116-.039-.173-.059.079-.462.13-.931.242-1.385.256-1.038.541-2.067.816-3.1.078-.291.225-.512.532-.623.414-.15.817-.329,1.222-.504.308-.132.534-.063.562.284.098,1.197.175,2.395.248,3.594.005.075-.102.157-.157.235-.067-.082-.171-.154-.193-.247-.061-.261-.088-.53-.14-.87",
            "m87.3314,22.6507c-.684.052-1.345.105-2.006.153-.551.041-.732-.107-.748-.638-.013-.431-.002-.863.001-1.294.002-.284.106-.466.431-.458.421.01.842.003,1.255.003.183.369-.059.343-.283.357-.786.051-1.032.429-.754,1.161.032.084.119.208.183.209.399.01.799.001,1.196-.029.064-.005.16-.141.17-.225.067-.608.118-1.219.171-1.829.037-.425-.208-.577-.586-.569-.427.01-.854.048-1.281.05-.105.001-.211-.087-.317-.135.087-.1.167-.279.262-.287.475-.043.956-.069,1.432-.048.959.042,1.098-.101,1.038,1.255-.029.66-.035,1.322-.061,1.982-.004.1-.058.198-.103.342",
            "m54.3828,14.1882c-.71.228-1.324.407-1.923.626-.265.096-.398.326-.337.63.048.244.14.413.434.279.098-.044.201-.078.306-.102.705-.168.76-.123.744.584-.001.075.011.15.017.225.057.663-.014.798-.625,1.053-.392.163-.796.297-1.197.438-.038.014-.088-.007-.271-.026.185-.18.285-.332.427-.406.312-.161.654-.264.963-.43.128-.069.257-.225.29-.365.137-.575-.059-.74-.624-.559-.733.234-.857.142-.871-.647-.014-.769-.018-.777.7-1.048.529-.2,1.063-.391,1.604-.553.32-.095.454-.254.42-.594-.026-.265-.066-.569.355-.703.045.316.089.618.143.999.201-.049.394-.112.592-.14.113-.017.234.022.352.035-.059.112-.114.32-.176.322-1.037.035-.821.841-.899,1.451-.054.426-.049.859-.101,1.285-.015.124-.134.237-.205.354-.039-.126-.111-.253-.113-.38-.01-.747-.005-1.494-.005-2.328",
            "m92.6729,21.061c-.147-.443.116-.46.4-.469.531-.017.787-.425.566-.911-.038-.083-.15-.181-.231-.185-.306-.015-.621-.032-.916.031-.125.027-.285.242-.298.383-.044.52-.025,1.045-.048,1.567-.011.27.108.35.358.34.46-.019.922-.034,1.382-.022.105.002.206.118.309.182-.08.065-.157.181-.241.188-.715.054-1.43.1-2.146.116-.094.002-.278-.188-.274-.283.035-.901.091-1.802.177-2.7.009-.098.239-.236.378-.251.516-.056,1.036-.078,1.555-.096.37-.012.617.109.566.557-.025.22.056.453.028.671-.106.828-.14.851-.982.881-.197.007-.395.001-.583.001",
            "m43.8042,20.8239c0-.671.012-1.343-.007-2.014-.006-.217.072-.536-.328-.534-.336.001-.86.347-.872.59-.035.718-.064,1.436-.095,2.154-.011.23-.007.472-.436.457.043-.775.085-1.549.129-2.323.003-.045.036-.094.026-.134-.188-.79.36-.975.932-1.164.711-.235,1.413-.496,2.12-.742.419-.145.573-.04.575.398.005.785.013,1.571-.008,2.356-.004.16-.13.317-.2.475-.061-.017-.122-.035-.184-.053,0-.702.005-1.404-.002-2.106-.002-.245.091-.564-.333-.57-.393-.006-.843.302-.859.601-.038.703-.057,1.407-.104,2.109-.012.186-.096.368-.147.551-.069-.017-.138-.034-.207-.051",
            "m88.6548,19.1767c0,.744.007,1.487-.003,2.231-.005.399.15.589.571.584,1.055-.012,1.09.133,1.182-1.147.035-.488.03-.98.093-1.464.015-.116.227-.208.348-.31.067.114.194.229.193.342-.013.797-.068,1.594-.076,2.391-.004.427-.134.665-.6.657-.742-.012-1.485-.003-2.236-.003,0-1.055-.013-2.068.018-3.08.003-.117.245-.228.376-.341l.134.14Z",
            "m39.4714,21.9571c.313-.081.498-.107.665-.177.312-.133.673-.219.694-.671.027-.608.076-1.215.117-1.839-.153.01-.271.009-.387.024-.655.088-1.039.441-1.082,1.064-.035.514-.007,1.031-.007,1.599m1.816-4.354c0,1.307.011,2.614-.014,3.921-.003.153-.168.378-.313.438-.435.183-.896.304-1.349.444-.266.083-.449-.04-.455-.297-.021-.827-.026-1.656.003-2.482.005-.141.186-.312.328-.403.217-.14.461-.267.71-.32.549-.117.9-.337.78-.984-.02-.111.126-.253.196-.38.038.021.076.042.114.063",
            "m95.5399,20.3048c.421,0,.847.012,1.273-.004.297-.011.432.101.407.4-.008.092-.001.185-.001.277,0,.909-.017.944-.895,1.078-.392.06-.793.072-1.19.075-.098.001-.196-.122-.293-.188.09-.098.165-.253.273-.28.2-.051.422-.006.629-.039.253-.041.52-.084.74-.202.118-.063.189-.285.2-.441.004-.062-.209-.19-.33-.199-.289-.022-.582.015-.873.018-.419.004-.626-.224-.618-.629.006-.304.035-.61.091-.909.016-.088.155-.21.245-.217.594-.047,1.191-.073,1.786-.088.074-.001.151.104.227.16-.083.092-.152.244-.249.265-.267.056-.546.063-.82.079-.669.037-.72.103-.602.844",
            "m72.0963,15.7862c0-.418.018-.889-.01-1.357-.01-.162-.134-.454-.206-.454-.352,0-.716.044-1.046.158-.073.025-.024.397-.037.609-.068,1.162.029,1.256,1.176,1.116.013-.001.025-.014.123-.072m-.117-2.232c.287-.263-.023-.788.549-.801v2.688c0,.791,0,.797-.77.827-.345.013-.701.039-1.035-.025-.145-.028-.343-.263-.354-.416-.043-.566-.023-1.137-.015-1.706.004-.368.202-.562.571-.566.368-.004.736-.001,1.054-.001",
            "m57.7873,13.6133c.526-.508,1.176-.037,1.757-.107.102-.013.346.301.35.469.015.621-.125,1.254-.051,1.864.087.724-.35.604-.758.618-.376.013-.751.032-1.126.054-.281.017-.428-.082-.403-.391.018-.229.003-.461.004-.691.003-.863.081-.879,1.075-.875.165.001.329.032.506.051-.044.449-.372.313-.597.317-.372.006-.618.075-.599.539.024.604.004.633.617.614.87-.028.818.131.878-.8.02-.318.034-.636.062-.952.033-.38-.178-.508-.511-.523-.194-.009-.389-.021-.584-.026-.198-.004-.396-.001-.594-.001l-.026-.16Z",
            "m65.1613,14.993c-.013-.001-.026-.002-.039-.002,0-.229.038-.467-.013-.683-.035-.143-.175-.32-.309-.369-.581-.211-.93.017-.986.615-.023.243-.025.487-.029.731-.01.572.103.684.69.691q.611.008.652-.621c.008-.121.023-.242.034-.362m-1.702.393c0-.365-.009-.731.002-1.096.021-.734.359-1,1.083-.869.919.167.929.167.981,1.133.025.464.02.932-.003,1.397-.013.265-.134.439-.467.423-.417-.021-.839.054-1.254.022-.122-.01-.283-.226-.326-.377-.056-.196-.014-.421-.014-.633h-.002",
            "m73.177,15.0545c.035-.364.088-.727.101-1.092.012-.343.2-.404.485-.38.395.033.791.079,1.186.073.312-.004.42.116.383.408-.005.045-.001.092,0,.138.002,1.067-.173,1.216-1.241,1.039-.08-.013-.146-.108-.218-.165.068-.05.13-.12.207-.143.085-.026.187-.027.274-.007.471.105.55-.231.587-.552.025-.225-.028-.422-.366-.439-.827-.042-.996.086-1,.891-.007,1.102-.006,1.089,1.079,1.098.217.002.533-.225.664.17-.22.059-.438.151-.661.169-.32.025-.645-.01-.967-.009-.344.001-.511-.146-.486-.505.016-.229.003-.46.003-.691-.01-.001-.02-.002-.03-.003",
            "m49.5354,18.6686c0-.655.013-1.31-.007-1.964-.007-.212.157-.545-.222-.601-.419-.062-.928.323-.938.676-.021.706-.021,1.412-.05,2.117-.006.135-.105.265-.16.398-.051-.014-.101-.027-.151-.04-.016-.113-.048-.227-.045-.339.026-.842.056-1.684.095-2.526.004-.095.047-.244.112-.271.465-.189.933-.38,1.418-.503.096-.025.377.231.384.366.037.798.03,1.599.005,2.397-.004.127-.177.249-.273.373-.056-.028-.112-.055-.168-.083",
            "m66.3059,16.2404c0-.823-.038-1.647.014-2.467.031-.483.523-.251.795-.336.226-.07.502.03.757.04.402.016.646.197.63.618-.025.641-.061,1.283-.116,1.922-.008.103-.141.195-.217.292-.046-.024-.092-.049-.139-.074,0-.582.002-1.164,0-1.745-.002-.544-.115-.639-.753-.642-.573-.003-.615.037-.624.63-.008.46.003.922-.024,1.382-.009.147-.114.289-.175.434-.049-.018-.099-.036-.148-.054",
            "m77.5021,15.915q.235-.737-.446-.775c-.227-.013-.454-.049-.68-.078-.044-.006-.12-.021-.124-.043-.069-.361-.183-.727-.161-1.084.008-.127.343-.312.543-.333.344-.036.7.03,1.049.069.07.008.132.086.197.131-.064.048-.123.127-.193.138-.286.043-.583.035-.86.106-.161.041-.292.197-.437.301.154.136.287.329.466.393.191.069.426.027.641.015.353-.02.511.169.51.491-.001.24-.019.491-.094.716-.041.123-.209.278-.33.287-.475.035-.953.025-1.43.013-.081-.002-.161-.095-.241-.146.084-.067.165-.188.252-.192.443-.02.888-.009,1.338-.009",
            "m62.0667,13.4263c.056.348-.133.43-.4.42-.324-.012-.419.148-.409.455.018.567.005,1.136.004,1.704,0,.282-.074.484-.447.382,0-.65-.015-1.29.005-1.928.018-.567.035-.566-.643-.674.15-.148.241-.318.351-.331.325-.038.386-.206.384-.494,0-.129.129-.259.199-.388.065.137.198.283.183.41-.041.345.097.445.41.42.118-.009.239.015.363.024",
            "m56.1022,16.5894c0-.963-.014-1.905.006-2.846.01-.429.136-.46.493-.252.113.067.312-.028.471-.019.114.006.226.062.339.096-.08.107-.158.306-.24.307-.648.012-.614.463-.615.898-.001.462.003.924-.002,1.386-.003.276-.093.474-.452.43",
            "m50.9234,15.1166c.119,1.114.357,2.189-.022,3.224-.067-.002-.133-.005-.2-.008,0-.984-.006-1.969.01-2.953.001-.089.138-.176.212-.263",
            "m62.8467,13.4259c0,.85.001,1.545-.001,2.24,0,.184.018.375-.027.548-.021.084-.164.157-.266.187-.03.009-.158-.142-.157-.219.008-.839.023-1.679.069-2.516.004-.081.23-.149.382-.24",
            "m46.8385,19.7256c-.008-.162-.024-.323-.023-.485.001-.75.008-1.501.011-2.251.001-.307.147-.408.365-.353v2.302c0,.152.024.31-.01.454-.033.138-.127.261-.194.391-.05-.02-.099-.039-.149-.058",
            "m77.7525,20.2283c-.067-.379-.016-.567.385-.494.186.034.396-.075.583-.045.115.019.207.178.309.274-.095.089-.183.242-.286.253-.318.033-.642.012-.991.012",
            "m47.2744,15.3038c-.104.315-.179.541-.254.768-.078-.05-.215-.093-.222-.152-.031-.258-.018-.517.476-.616",
            "m50.8213,14.4532c-.168-.509-.138-.592.327-.681-.066.268-.122.499-.179.729-.049-.016-.099-.032-.148-.048"
      ],
          polygons: []
        }
      };

      const GCI_CATS = {"allgemein":{"label_de":"Allgemein","label_en":"General","items":["goetheanum","buehne"]},"sektionen":{"label_de":"Sektionen","label_en":"Sections","items":["aas","js","mas","ms","nws","ps","sbk","hpise","lws","srmk","ssw","szw"]},"bereiche":{"label_de":"Bereiche","label_en":"Departments","items":["bauadmin","dokumentation","empfang","gaertnerei","kommunikation","studium"]},"teilbereiche":{"label_de":"Teilbereiche","label_en":"Subdepartments","items":["archiv","betriebsdienst","betriebsleitung","bibliothek","campus","finanzwesen","freiwilligenarbeit","kunstsammlung","leitung","medienarbeit","personalwesen","raumplanung","saaldienst","studio","vorstand"]}};

      const GCI_ORGS = {"goetheanum":{"name_de":"Goetheanum","name_en":"Goetheanum","name_fr":"Goetheanum","name_es":"Goetheanum","short_de":"Goetheanum","short_en":"Goetheanum","short_fr":"Goetheanum","short_es":"Goetheanum","color":"#0061a9"},"aas":{"name_de":"Allgemeine Anthroposophische Sektion","name_en":"General Anthroposophical Section","name_fr":"Section d'anthroposophie générale","name_es":"Sección Antroposófica General","short_de":"Allgemeine Anthroposophie","short_en":"General Anthroposophy","short_fr":"Anthroposophie générale","short_es":"Antroposofía General","color":"#a24f8a"},"ps":{"name_de":"Pädagogische Sektion","name_en":"Padagogical Section","name_fr":"Section pédagogique","name_es":"Sección Pedagogica","short_de":"Pädagogik","short_en":"Pedagogy","short_fr":"Pédagogie","short_es":"Pedagogía","color":"#3b4881"},"ms":{"name_de":"Medizinische Sektion","name_en":"Medical Section","name_fr":"Section médicale","name_es":"Sección Médicina","short_de":"Medizin","short_en":"Medicine","short_fr":"Médicale","short_es":"Médica","color":"#5f5599"},"nws":{"name_de":"Naturwissenschaftliche Sektion","name_en":"Natural Science Section","name_fr":"Section des sciences naturelles","name_es":"Sección de Ciencias Naturales","short_de":"Naturwissenschaften","short_en":"Natural Science","short_fr":"Sciences naturelles","short_es":"Ciencias Naturales","color":"#1e7b6e"},"lws":{"name_de":"Sektion für Landwirtschaft","name_en":"Section for Agriculture","name_fr":"Section d'agriculture","name_es":"Sección de Agricultura","short_de":"Landwirtschaft","short_en":"Agriculture","short_fr":"Agriculture","short_es":"Agricultura","color":"#63b145"},"sbk":{"name_de":"Sektion für Bildende Künste","name_en":"Visual Art Section","name_fr":"Section des arts plastiques","name_es":"Sección de Artes Plásticas","short_de":"Bildende Künste","short_en":"Visual Art","short_fr":"Arts plastiques","short_es":"Artes Plásticas","color":"#d072a0"},"ssw":{"name_de":"Sektion für Schöne Wissenschaften","name_en":"Section for the Literary Arts and Humanities","name_fr":"Section des Belles-Lettres","name_es":"Sección de Literatura y Humanidades","short_de":"Schöne Wissenschaften","short_en":"Literary Arts and Humanities","short_fr":"Belles-Lettres","short_es":"Literatura y Humanidades","color":"#5168c0"},"szw":{"name_de":"Sektion für Sozialwissenschaft","name_en":"Section for Social Sciences","name_fr":"Section des sciences sociales","name_es":"Sección de Ciencias Sociales","short_de":"Sozialwissenschaft","short_en":"Social Sciences","short_fr":"Sciences sociales","short_es":"Ciencias Sociales","color":"#df4164"},"js":{"name_de":"Jugendsektion","name_en":"Youth Section","name_fr":"Section jeunesse","name_es":"Sección para la Juventud","short_de":"Jugendsektion","short_en":"Youth Section","short_fr":"Section jeunesse","short_es":"Sección para la Juventud","color":"#ff675d"},"srmk":{"name_de":"Sektion für Redende und Musizierende Künste","name_en":"Section for the Performing Arts","name_fr":"Section des arts de la parole et de la musique","name_es":"Sección de Artes de la Palabra y de la Música","short_de":"Redende und Musizierende Künste","short_en":"Performing Arts","short_fr":"Arts de la parole et musique","short_es":"Artes de la Palabra y Música","color":"#598ddc"},"mas":{"name_de":"Mathematisch-Astronomische Sektion","name_en":"Section for Mathematics and Astronomy","name_fr":"Section mathématique-astronomie","name_es":"Sección Matemático-Astronómica","short_de":"Mathematik und Astronomie","short_en":"Mathematics and Astronomy","short_fr":"Mathématique-astronomie","short_es":"Matemático-Astronómica","color":"#2e54a4"},"hpise":{"name_de":"Sektion für Heilpädagogik und inklusive soziale Entwicklung","name_en":"Section for Inclusive Social Development","short_de":"Heilpädagogik und inklusive soziale Entwicklung","short_en":"Inclusive Social Development","color":"#f98a3c","name_fr":"Section for Inclusive Social Development","name_es":"Section for Inclusive Social Development","short_fr":"Inclusive Social Development","short_es":"Inclusive Social Development"},"bauadmin":{"name_de":"Bau-Administration","name_en":"Building Administration","name_fr":"Administration des bâtiments","name_es":"Administración de edificios","short_de":"Bau-Administration","short_en":"Building Administration","short_fr":"Administration bâtiments","short_es":"Administración edificios","color":"#b15359"},"buehne":{"name_de":"Bühne","name_en":"Stage","name_fr":"Scène","name_es":"Escenario","short_de":"Bühne","short_en":"Stage","short_fr":"Scène","short_es":"Escenario","color":"#968250"},"dokumentation":{"name_de":"Dokumentation","name_en":"Documentation","name_fr":"Documentation","name_es":"Documentación","short_de":"Dokumentation","short_en":"Documentation","short_fr":"Documentation","short_es":"Documentación","color":"#005eb8"},"empfang":{"name_de":"Empfang","name_en":"Reception","name_fr":"Réception","name_es":"Recepción","short_de":"Empfang","short_en":"Reception","short_fr":"Réception","short_es":"Recepción","color":"#005eb8"},"kommunikation":{"name_de":"Kommunikation","name_en":"Communication","name_fr":"Communication","name_es":"Comunicación","short_de":"Kommunikation","short_en":"Communication","short_fr":"Communication","short_es":"Comunicación","color":"#005eb8"},"studium":{"name_de":"Studium","name_en":"Studies","name_fr":"Études","name_es":"Estudios","short_de":"Studium","short_en":"Studies","short_fr":"Études","short_es":"Estudios","color":"#005eb8"},"campus":{"name_de":"Campus","name_en":"Campus","name_fr":"Campus","name_es":"Campus","short_de":"Campus","short_en":"Campus","short_fr":"Campus","short_es":"Campus","color":"#005eb8"},"archiv":{"name_de":"Archiv","name_en":"Archive","name_fr":"Archives","name_es":"Archivo","short_de":"Archiv","short_en":"Archive","short_fr":"Archives","short_es":"Archivo","color":"#005eb8"},"personalwesen":{"name_de":"Personalwesen","name_en":"Human Resources","name_fr":"Ressources humaines","name_es":"Recursos humanos","short_de":"Personalwesen","short_en":"Human Resources","short_fr":"Ressources humaines","short_es":"Recursos humanos","color":"#005eb8"},"kunstsammlung":{"name_de":"Kunstsammlung","name_en":"Art Collection","name_fr":"Collection d'art","name_es":"Colección de arte","short_de":"Kunstsammlung","short_en":"Art Collection","short_fr":"Collection d'art","short_es":"Colección de arte","color":"#005eb8"},"finanzwesen":{"name_de":"Finanzwesen","name_en":"Finance","name_fr":"Finances","name_es":"Finanzas","short_de":"Finanzwesen","short_en":"Finance","short_fr":"Finances","short_es":"Finanzas","color":"#005eb8"},"betriebsdienst":{"name_de":"Betriebsdienst","name_en":"Operations","name_fr":"Services opérationnels","name_es":"Servicios operativos","short_de":"Betriebsdienst","short_en":"Operations","short_fr":"Services opérationnels","short_es":"Servicios operativos","color":"#005eb8"},"bibliothek":{"name_de":"Bibliothek","name_en":"Library","name_fr":"Bibliothèque","name_es":"Biblioteca","short_de":"Bibliothek","short_en":"Library","short_fr":"Bibliothèque","short_es":"Biblioteca","color":"#005eb8"},"gaertnerei":{"name_de":"Gärtnerei","name_en":"Gardens","name_fr":"Jardins","name_es":"Jardines","short_de":"Gärtnerei","short_en":"Gardens","short_fr":"Jardins","short_es":"Jardines","color":"#63b145"},"saaldienst":{"name_de":"Saaldienst","name_en":"Hall Service","name_fr":"Service de salle","name_es":"Servicio de sala","short_de":"Saaldienst","short_en":"Hall Service","short_fr":"Service de salle","short_es":"Servicio de sala","color":"#005eb8"},"freiwilligenarbeit":{"name_de":"Freiwilligenarbeit","name_en":"Volunteer Work","name_fr":"Bénévolat","name_es":"Trabajo voluntario","short_de":"Freiwilligenarbeit","short_en":"Volunteer Work","short_fr":"Bénévolat","short_es":"Trabajo voluntario","color":"#005eb8"},"leitung":{"name_de":"Leitung","name_en":"Management","name_fr":"Direction","name_es":"Dirección","short_de":"Leitung","short_en":"Management","short_fr":"Direction","short_es":"Dirección","color":"#005eb8"},"vorstand":{"name_de":"Vorstand","name_en":"Executive Board","name_fr":"Conseil d'administration","name_es":"Junta directiva","short_de":"Vorstand","short_en":"Executive Board","short_fr":"Conseil d'administration","short_es":"Junta directiva","color":"#005eb8"},"betriebsleitung":{"name_de":"Betriebsleitung","name_en":"Operations Management","name_fr":"Direction des opérations","name_es":"Dirección de operaciones","short_de":"Betriebsleitung","short_en":"Operations Management","short_fr":"Direction des opérations","short_es":"Dirección de operaciones","color":"#005eb8"},"medienarbeit":{"name_de":"Medienarbeit","name_en":"Media Work","name_fr":"Travail médiatique","name_es":"Trabajo de medios","short_de":"Medienarbeit","short_en":"Media Work","short_fr":"Travail médiatique","short_es":"Trabajo de medios","color":"#005eb8"},"raumplanung":{"name_de":"Raumplanung","name_en":"Space Planning","name_fr":"Planification spatiale","name_es":"Planificación espacial","short_de":"Raumplanung","short_en":"Space Planning","short_fr":"Planification spatiale","short_es":"Planificación espacial","color":"#005eb8"},"studio":{"name_de":"Studio","name_en":"Studio","name_fr":"Studio","name_es":"Estudio","short_de":"Studio","short_en":"Studio","short_fr":"Studio","short_es":"Estudio","color":"#005eb8"}};

      const HOCHSCHULE_KEYS = ((GCI_CATS.sektionen && GCI_CATS.sektionen.items) || []).slice();
      const BEREICHE_KEYS = Array.from(
        new Set(
          ["buehne"]
            .concat((GCI_CATS.bereiche && GCI_CATS.bereiche.items) || [])
            .concat((GCI_CATS.teilbereiche && GCI_CATS.teilbereiche.items) || [])
        )
      ).sort(function (a, b) {
        const aName = (GCI_ORGS[a] && GCI_ORGS[a].name_de) || a;
        const bName = (GCI_ORGS[b] && GCI_ORGS[b].name_de) || b;
        return aName.localeCompare(bName, "de", { sensitivity: "base" });
      });

      const ORG_CATS = {
        hochschule: {
          label_de: "Hochschule",
          label_en: "School",
          items: HOCHSCHULE_KEYS
        },
        gesellschaft: {
          label_de: "Gesellschaft",
          label_en: "Society",
          items: ["gesellschaft"]
        },
        bereiche: {
          label_de: "Bereiche",
          label_en: "Departments",
          items: BEREICHE_KEYS
        }
      };

      const ORG_DEFS = Object.assign(
        {
          gesellschaft: {
            label: "Gesellschaft",
            labelDe: "Gesellschaft",
            labelEn: "Society",
            name: "Allgemeine Anthroposophische Gesellschaft",
            nameDe: "Allgemeine Anthroposophische Gesellschaft",
            nameEn: "General Anthroposophical Society",
            color: "#f07b76",
            motif: "gesellschaft"
          }
        },
        Object.keys(GCI_ORGS).reduce(function (acc, key) {
          const org = GCI_ORGS[key] || {};
          let motif = "icon";
          if (HOCHSCHULE_KEYS.indexOf(key) !== -1) {
            motif = "hochschule";
          } else if (key === "bauadmin") {
            motif = "bau";
          }
          const nameDe = org.name_de || key;
          const nameEn = org.name_en || nameDe;
          const labelDe = org.short_de || nameDe;
          const labelEn = org.short_en || nameEn;
          acc[key] = {
            label: labelDe,
            labelDe: labelDe,
            labelEn: labelEn,
            name: nameDe,
            nameDe: nameDe,
            nameEn: nameEn,
            color: org.color || "#005eb8",
            motif: motif
          };
          return acc;
        }, {})
      );

      const SECTION_WEBSITES = {
        aas: "allgemeine-sektion.goetheanum.ch",
        js: "youthsection.org",
        mas: "mas.goetheanum.org",
        nws: "forschungsinstitut.ch",
        lws: "sektion-landwirtschaft.org",
        srmk: "srmk.goetheanum.org",
        sbk: "sbk.goetheanum.org",
        ssw: "ssw.goetheanum.org",
        szw: "social.goetheanum.ch",
        ps: "goetheanum-paedagogik.ch",
        hpise: "inclusivesocial.goetheanum.ch",
        ms: "medsektion-goetheanum.org"
      };

      const EXAMPLE_PRESETS = {
        gesellschaft: {
          symbolSet: "gesellschaft",
          fullName: "Rudolf Steiner",
          roleLinesDe: [
            "Vorstand der Allgemeinen",
            "Anthroposophischen Gesellschaft"
          ],
          roleLinesEn: [
            "Executive Council Member of the",
            "General Anthroposophical Society"
          ],
          contactLines: [
            "Hügelweg 59 · 4143 Dornach",
            "Switzerland | +41 61 706 4X XX",
            "rudolf.steiner@goetheanum.ch",
            "www.goetheanum.ch"
          ]
        },
        bauadmin: {
          symbolSet: "bau",
          fullName: "Rudolf Steiner",
          roleLinesDe: ["Administration des", "Goetheanum-Baues"],
          roleLinesEn: ["Administration of the", "Goetheanum Building"],
          contactLines: [
            "Postfach · CH 4143 Dornach",
            "Telefon +41 61 706 4X XX",
            "name@goetheanum.ch"
          ]
        },
        buehne: {
          symbolSet: "icon",
          fullName: "Vorname Nachname",
          roleLinesDe: ["Bühne"],
          roleLinesEn: [],
          contactLines: [
            "Hügelweg 59 · 4143 Dornach",
            "Telefon +41 61 706 4X XX",
            "name@goetheanum.ch",
            "www.goetheanum.ch"
          ]
        }
      };

      function wrapPresetByChars(text, maxChars) {
        const source = String(text || "").trim();
        if (!source) {
          return [];
        }
        const words = source.split(/\s+/).filter(Boolean);
        const limit = Math.max(16, Number(maxChars) || 32);
        const lines = [];
        let current = "";

        words.forEach(function (word) {
          const next = current ? (current + " " + word) : word;
          if (next.length <= limit || !current) {
            current = next;
          } else {
            lines.push(current);
            current = word;
          }
        });

        if (current) {
          lines.push(current);
        }
        return lines;
      }

      function sectionWebsiteFor(schemaKey) {
        return SECTION_WEBSITES[schemaKey] || "goetheanum.ch";
      }

      const SECTION_ROLE_OVERRIDES_DE = {
        aas: [
          "Leiter der Allgemeinen",
          "Anthroposophischen Sektion",
          "der Freien Hochschule",
          "für Geisteswissenschaft"
        ],
        js: [
          "Leiter der Jugendsektion",
          "der Freien Hochschule",
          "für Geisteswissenschaft"
        ],
        mas: [
          "Leiter der Mathematisch-",
          "Astronomischen Sektion",
          "der Freien Hochschule",
          "für Geisteswissenschaft"
        ],
        ms: [
          "Leiter der Medizinischen",
          "Sektion der Freien Hochschule",
          "für Geisteswissenschaft"
        ],
        nws: [
          "Leiter der Naturwissenschaftlichen",
          "Sektion der Freien Hochschule",
          "für Geisteswissenschaft"
        ],
        ps: [
          "Leiter der Pädagogischen",
          "Sektion der Freien Hochschule",
          "für Geisteswissenschaft"
        ],
        sbk: [
          "Leiter der Sektion für",
          "Bildende Künste der Freien",
          "Hochschule für Geisteswissenschaft"
        ],
        hpise: [
          "Leiter der Sektion für",
          "Heilpädagogik und inklusive",
          "soziale Entwicklung der",
          "Freien Hochschule für",
          "Geisteswissenschaft"
        ],
        lws: [
          "Leiter der Sektion für",
          "Landwirtschaft der Freien",
          "Hochschule für Geisteswissenschaft"
        ],
        srmk: [
          "Leiter der Sektion für Redende",
          "und Musizierende Künste",
          "der Freien Hochschule",
          "für Geisteswissenschaft"
        ],
        ssw: [
          "Leiter der Sektion für Schöne",
          "Wissenschaften der Freien",
          "Hochschule für Geisteswissenschaft"
        ],
        szw: [
          "Leiter der Sektion für",
          "Sozialwissenschaft der",
          "Freien Hochschule für",
          "Geisteswissenschaft"
        ]
      };

      const SECTION_ROLE_OVERRIDES_EN = {
        aas: [
          "Leader of the General",
          "Anthroposophical Section of the",
          "School of Spiritual Science"
        ],
        js: [
          "Leader of the Youth Section",
          "of the School of Spiritual Science"
        ],
        mas: [
          "Leader of the Section for",
          "Mathematics and Astronomy",
          "of the School of Spiritual Science"
        ],
        ms: [
          "Leader of the Medical Section",
          "of the School of Spiritual Science"
        ],
        nws: [
          "Leader of the Natural Science",
          "Section of the School of",
          "Spiritual Science"
        ],
        ps: [
          "Leader of the Pedagogical Section",
          "of the School of Spiritual Science"
        ],
        sbk: [
          "Leader of the Visual Art Section",
          "of the School of Spiritual Science"
        ],
        hpise: [
          "Leader of the Section for",
          "Inclusive Social Development",
          "of the School of Spiritual Science"
        ],
        lws: [
          "Leader of the Section for",
          "Agriculture of the School of",
          "Spiritual Science"
        ],
        srmk: [
          "Leader of the Section for",
          "the Performing Arts of the",
          "School of Spiritual Science"
        ],
        ssw: [
          "Leader of the Section for",
          "the Literary Arts and Humanities",
          "of the School of Spiritual Science"
        ],
        szw: [
          "Leader of the Section for",
          "Social Sciences of the",
          "School of Spiritual Science"
        ]
      };

      function sectionRoleLinesDe(schemaKey) {
        if (SECTION_ROLE_OVERRIDES_DE[schemaKey]) {
          return SECTION_ROLE_OVERRIDES_DE[schemaKey].slice();
        }
        const org = GCI_ORGS[schemaKey] || {};
        const sectionName = org.name_de || (ORG_DEFS[schemaKey] && ORG_DEFS[schemaKey].name) || "Sektion";
        const lineA = wrapPresetByChars("Leiter der " + sectionName, 30);
        const lineB = wrapPresetByChars("der Freien Hochschule für Geisteswissenschaft", 24);
        return lineA.concat(lineB);
      }

      function sectionRoleLinesEn(schemaKey) {
        if (SECTION_ROLE_OVERRIDES_EN[schemaKey]) {
          return SECTION_ROLE_OVERRIDES_EN[schemaKey].slice();
        }
        const org = GCI_ORGS[schemaKey] || {};
        const sectionName = org.name_en || "Section";
        const lineA = wrapPresetByChars("Leader of the " + sectionName, 26);
        const joined = lineA.slice();
        const tailPrefix = "of the";
        if (joined.length && (joined[joined.length - 1] + " " + tailPrefix).length <= 34) {
          joined[joined.length - 1] = joined[joined.length - 1] + " " + tailPrefix;
        } else {
          joined.push(tailPrefix);
        }
        const lineB = wrapPresetByChars("School of Spiritual Science", 24);
        return joined.concat(lineB);
      }

      function sectionExamplePreset(schemaKey) {
        return {
          symbolSet: "hochschule",
          fullName: "Dr. Rudolf Steiner",
          roleLinesDe: sectionRoleLinesDe(schemaKey),
          roleLinesEn: sectionRoleLinesEn(schemaKey),
          contactLines: [
            "Hügelweg 59 · 4143 Dornach",
            "Switzerland | +41 61 706 4X XX",
            "rudolf.steiner@goetheanum.ch",
            sectionWebsiteFor(schemaKey)
          ]
        };
      }

      const BEREICHE_ROLE_TITLES_DE = {
        gaertnerei: "Gärtnerin",
        buehne: "Bühnenmitarbeit",
        empfang: "Empfangsmitarbeit",
        dokumentation: "Dokumentationsassistenz",
        kommunikation: "Kommunikationsmitarbeit",
        studium: "Studienkoordination",
        archiv: "Archivar",
        bibliothek: "Bibliothekarin",
        personalwesen: "Personalreferentin",
        finanzwesen: "Finanzsachbearbeitung",
        betriebsdienst: "Haustechnik",
        freiwilligenarbeit: "Freiwilligenkoordination",
        kunstsammlung: "Kuratorische Assistenz",
        saaldienst: "Saaldienst",
        leitung: "Leitung",
        vorstand: "Vorstandsassistenz",
        betriebsleitung: "Betriebsleitung",
        medienarbeit: "Redaktion",
        raumplanung: "Raumplanung",
        studio: "Studioleitung",
        campus: "Campuskoordination"
      };

      const BEREICHE_ROLE_TITLES_EN = {
        gaertnerei: "Gardener",
        buehne: "Stage Team",
        empfang: "Reception Staff",
        dokumentation: "Documentation Assistant",
        kommunikation: "Communication Staff",
        studium: "Study Coordination",
        archiv: "Archivist",
        bibliothek: "Librarian",
        personalwesen: "HR Officer",
        finanzwesen: "Finance Officer",
        betriebsdienst: "Operations Staff",
        freiwilligenarbeit: "Volunteer Coordinator",
        kunstsammlung: "Curatorial Assistant",
        saaldienst: "Hall Service",
        leitung: "Management",
        vorstand: "Board Assistant",
        betriebsleitung: "Operations Management",
        medienarbeit: "Media Editor",
        raumplanung: "Space Planning",
        studio: "Studio Lead",
        campus: "Campus Coordination"
      };

      function bereicheRoleLineDe(schemaKey) {
        return BEREICHE_ROLE_TITLES_DE[schemaKey] || "Mitarbeit";
      }

      function bereicheRoleLineEn(schemaKey) {
        return BEREICHE_ROLE_TITLES_EN[schemaKey] || "Staff";
      }

      function bereicheExamplePreset(schemaKey) {
        return {
          symbolSet: defaultSymbolForSchema(schemaKey),
          fullName: "Rudolf Steiner",
          roleLinesDe: [bereicheRoleLineDe(schemaKey)],
          roleLinesEn: [bereicheRoleLineEn(schemaKey)],
          contactLines: defaultContactLines(schemaKey)
        };
      }

      function examplePresetFor(schemaKey) {
        if (HOCHSCHULE_KEYS.indexOf(schemaKey) !== -1) {
          return sectionExamplePreset(schemaKey);
        }
        if (schemaKey === "bauadmin") {
          return EXAMPLE_PRESETS.bauadmin || null;
        }
        if (categoryForSchema(schemaKey) === "bereiche") {
          return bereicheExamplePreset(schemaKey);
        }
        return EXAMPLE_PRESETS[schemaKey] || null;
      }

      const fieldIds = [
        "orgCategory",
        "schema",
        "cardFormat",
        "includeCrop",
        "fullName",
        "roleBlock",
        "roleBlockEn",
        "contactBlock"
      ];

      const refs = fieldIds.reduce((acc, id) => {
        acc[id] = document.getElementById(id);
        return acc;
      }, {});

      const CARD_DEFAULTS = {
        textColor: "#595959",
        bgColor: "#ffffff"
      };

      const GCI_GLYPHS = window.GCI_GLYPHS || {};
      const GCI_FONT_UPM = window.GCI_FONT_UPM || 1000;
      const TITILLIUM_OUTLINE_PAYLOAD = window.TITILLIUM_OUTLINE_GLYPHS || {};
      const TITILLIUM_OUTLINE_GLYPHS = TITILLIUM_OUTLINE_PAYLOAD.fonts || TITILLIUM_OUTLINE_PAYLOAD;
      const TITILLIUM_OUTLINE_UPM = window.TITILLIUM_OUTLINE_UPM || TITILLIUM_OUTLINE_PAYLOAD.upm || 1000;
      const TITILLIUM_OUTLINE_READY = Boolean(
        TITILLIUM_OUTLINE_GLYPHS &&
        Object.keys(TITILLIUM_OUTLINE_GLYPHS).length
      );

      const UI_I18N = {
        de: {
          field_entity: "Entität",
          field_person: "Person",
          field_contact: "Kontakt",
          label_category: "Kategorie",
          label_unit: "Einheit / Sektion / Bereich",
          label_format: "Format",
          label_name: "Name",
          label_role: "Funktion / Organisation",
          label_role_en: "Englische Übersetzung",
          format_portrait: "Hochformat",
          format_landscape: "Querformat",
          cat_society: "Gesellschaft",
          cat_school: "Hochschule",
          cat_divisions: "Bereiche",
          crop_label: "3 mm Beschnitt + Schnittmarken",
          btn_pdf: "PDF",
          btn_svg: "SVG",
          btn_png: "PNG",
          btn_sheet: "Druckbogen",
          tip_pdf: "Einzelkarte als Vektor-PDF ohne Schnittmarken. Für Marken den Druckbogen verwenden.",
          tip_svg: "Vektor-SVG. Falls verfügbar mit Textpfaden, sonst mit Titillium-Schriftdefinition.",
          tip_png: "Rasterbild als Notlösung, Export in 600 dpi für hohe Auflösung.",
          tip_sheet: "A4-Druckbogen als Vektor-PDF mit maximaler Anzahl Karten; optional mit Schnittmarken.",
          owner_mode_on: "Schnell-Download aktiv",
          email_gate_title: "Datei per E-Mail anfordern",
          email_gate_copy: "Erlaubt sind nur Empfänger mit @goetheanum.ch.",
          email_gate_format: "Format",
          email_gate_label: "E-Mail-Adresse",
          email_gate_submit: "Anfordern",
          email_gate_cancel: "Abbrechen",
          email_gate_invalid: "Bitte eine gültige @goetheanum.ch-Adresse eingeben.",
          email_gate_missing_endpoint: "E-Mail-Versand ist noch nicht konfiguriert.",
          email_gate_success: "Anfrage gesendet. Die Datei wird an die angegebene Adresse zugestellt.",
          email_gate_requesting: "Anfrage …",
          placeholder_name: "Vorname Nachname",
          placeholder_role: "Vorstand der Allgemeinen\nAnthroposophischen Gesellschaft\nFreie Hochschule für Geisteswissenschaft",
          placeholder_role_en: "Executive Council Member of the\nGeneral Anthroposophical Society",
          placeholder_contact: "Hügelweg 59 · 4143 Dornach\nTelefon +41 61 706 4X XX\nname@goetheanum.ch\nwww.goetheanum.ch",
          meta_fallback_unit: "Einheit"
        },
        en: {
          field_entity: "Entity",
          field_person: "Person",
          field_contact: "Contact",
          label_category: "Category",
          label_unit: "Unit / Section / Department",
          label_format: "Format",
          label_name: "Name",
          label_role: "Role / Organization",
          label_role_en: "English translation",
          format_portrait: "Portrait",
          format_landscape: "Landscape",
          cat_society: "Society",
          cat_school: "School",
          cat_divisions: "Departments",
          crop_label: "3 mm bleed + crop marks",
          btn_pdf: "PDF",
          btn_svg: "SVG",
          btn_png: "PNG",
          btn_sheet: "Print Sheet",
          tip_pdf: "Single card as vector PDF without crop marks. Use Print Sheet for crop marks.",
          tip_svg: "Vector SVG. If available with text paths, otherwise with Titillium font definition.",
          tip_png: "Raster fallback export at 600 dpi for high resolution.",
          tip_sheet: "A4 print sheet as vector PDF with maximum number of cards; crop marks optional.",
          owner_mode_on: "Quick download active",
          email_gate_title: "Request file by email",
          email_gate_copy: "Only recipients with @goetheanum.ch are allowed.",
          email_gate_format: "Format",
          email_gate_label: "Email address",
          email_gate_submit: "Request",
          email_gate_cancel: "Cancel",
          email_gate_invalid: "Please enter a valid @goetheanum.ch address.",
          email_gate_missing_endpoint: "Email delivery endpoint is not configured yet.",
          email_gate_success: "Request sent. The file will be delivered to the specified address.",
          email_gate_requesting: "Request …",
          placeholder_name: "First name Last name",
          placeholder_role: "Executive Council Member of the\nGeneral Anthroposophical Society",
          placeholder_role_en: "Optional English translation",
          placeholder_contact: "Huegelweg 59 · 4143 Dornach\nPhone +41 61 706 4X XX\nname@goetheanum.ch\nwww.goetheanum.ch",
          meta_fallback_unit: "Unit"
        }
      };

      const previewCard = document.getElementById("previewCard");
      const printCard = document.getElementById("printCard");
      const previewZoom = document.getElementById("previewZoom");
      const stageEl = document.querySelector(".stage");
      const printArtboard = document.getElementById("printArtboard");
      const uiLangToggle = document.getElementById("uiLangToggle");
      const ownerModeSwitch = document.getElementById("ownerModeSwitch");
      const ownerModeState = document.getElementById("ownerModeState");
      const ownerModeStateText = document.getElementById("ownerModeStateText");
      const emailGate = document.getElementById("emailGate");
      const emailGateForm = document.getElementById("emailGateForm");
      const emailGateAddress = document.getElementById("emailGateAddress");
      const emailGateError = document.getElementById("emailGateError");
      const emailGateSubmit = document.getElementById("emailGateSubmit");
      const emailGateCancel = document.getElementById("emailGateCancel");
      const emailGateFormat = document.getElementById("emailGateFormat");

      let lastPreset = null;
      let currentUiLang = "de";
      let ownerModeEnabled = false;
      let ownerTapCount = 0;
      let ownerTapTimer = null;
      let pendingEmailRequest = null;

      const OWNER_MODE_STORAGE_KEY = "vk_owner_mode_bypass";
      const EMAIL_TARGET_STORAGE_KEY = "vk_last_email_target";
      const EMAIL_EXPORT_ENDPOINT =
        (window.VK_EMAIL_EXPORT_ENDPOINT || localStorage.getItem("vk_email_export_endpoint") || "").trim();

      function uiDict() {
        return UI_I18N[currentUiLang] || UI_I18N.de;
      }

      function textById(id, value) {
        const el = document.getElementById(id);
        if (el) {
          el.textContent = value;
        }
      }

      function placeholderById(id, value) {
        const el = document.getElementById(id);
        if (el) {
          el.setAttribute("placeholder", value);
        }
      }

      function orgNameForUi(org) {
        if (!org) {
          return "";
        }
        if (currentUiLang === "en") {
          return org.nameEn || org.name || org.nameDe || "";
        }
        return org.nameDe || org.name || org.nameEn || "";
      }

      function isGoetheanumEmail(value) {
        return /^[a-z0-9._%+-]+@goetheanum\.ch$/i.test(String(value || "").trim());
      }

      function updateOwnerModeUi() {
        if (!ownerModeState || !ownerModeStateText) {
          return;
        }
        ownerModeState.classList.toggle("on", ownerModeEnabled);
        ownerModeStateText.textContent = uiDict().owner_mode_on;
      }

      function setOwnerModeEnabled(enabled) {
        ownerModeEnabled = Boolean(enabled);
        try {
          localStorage.setItem(OWNER_MODE_STORAGE_KEY, ownerModeEnabled ? "1" : "0");
        } catch (err) {
          // no-op
        }
        updateOwnerModeUi();
      }

      function handleOwnerTap() {
        ownerTapCount += 1;
        if (ownerTapTimer) {
          clearTimeout(ownerTapTimer);
        }
        ownerTapTimer = setTimeout(function () {
          ownerTapCount = 0;
          ownerTapTimer = null;
        }, 1300);
        if (ownerTapCount >= 5) {
          setOwnerModeEnabled(!ownerModeEnabled);
          ownerTapCount = 0;
          if (ownerTapTimer) {
            clearTimeout(ownerTapTimer);
            ownerTapTimer = null;
          }
        }
      }

      function openEmailGate(payload) {
        if (!emailGate || !emailGateAddress || !emailGateFormat) {
          return;
        }
        pendingEmailRequest = payload || null;
        emailGate.classList.add("open");
        emailGate.setAttribute("aria-hidden", "false");
        emailGateError.textContent = "";
        emailGateFormat.textContent = uiDict().email_gate_format + ": " + (payload && payload.label ? payload.label : "");
        const preferred = (function () {
          try {
            return localStorage.getItem(EMAIL_TARGET_STORAGE_KEY) || "";
          } catch (err) {
            return "";
          }
        })();
        emailGateAddress.value = preferred;
        setTimeout(function () {
          emailGateAddress.focus();
          emailGateAddress.select();
        }, 20);
      }

      function closeEmailGate() {
        if (!emailGate) {
          return;
        }
        pendingEmailRequest = null;
        emailGate.classList.remove("open");
        emailGate.setAttribute("aria-hidden", "true");
        emailGateError.textContent = "";
        if (emailGateSubmit) {
          emailGateSubmit.disabled = false;
          emailGateSubmit.textContent = uiDict().email_gate_submit;
        }
      }

      async function sendEmailExportRequest(request) {
        if (!EMAIL_EXPORT_ENDPOINT) {
          throw new Error(uiDict().email_gate_missing_endpoint);
        }
        const response = await fetch(EMAIL_EXPORT_ENDPOINT, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(request)
        });
        if (!response.ok) {
          throw new Error("E-Mail-Request fehlgeschlagen (" + response.status + ").");
        }
        return response;
      }

      async function ensureExportAuthorized(kindLabel, exportKind, model, runDirect) {
        if (ownerModeEnabled) {
          await runDirect();
          return;
        }
        openEmailGate({
          kind: exportKind,
          label: kindLabel,
          model: model
        });
      }

      function applyUiLanguage(lang) {
        const next = lang === "en" ? "en" : "de";
        const dict = UI_I18N[next] || UI_I18N.de;
        currentUiLang = next;
        document.documentElement.lang = next;
        if (uiLangToggle) {
          uiLangToggle.setAttribute("aria-label", next === "en" ? "Language" : "Sprache");
        }

        textById("fsEntityTitle", dict.field_entity);
        textById("fsPersonTitle", dict.field_person);
        textById("fsContactTitle", dict.field_contact);
        textById("lblOrgCategory", dict.label_category);
        textById("lblSchema", dict.label_unit);
        textById("formatLabel", dict.label_format);
        textById("lblFullName", dict.label_name);
        textById("lblRoleBlock", dict.label_role);
        textById("lblRoleBlockEn", dict.label_role_en);
        textById("optFormatPortrait", dict.format_portrait);
        textById("optFormatLandscape", dict.format_landscape);
        textById("optCatGesellschaft", dict.cat_society);
        textById("optCatHochschule", dict.cat_school);
        textById("optCatBereiche", dict.cat_divisions);
        textById("cropLabelText", dict.crop_label);
        textById("btnPdf", dict.btn_pdf);
        textById("btnSvg", dict.btn_svg);
        textById("btnPng", dict.btn_png);
        textById("btnSheetPdf", dict.btn_sheet);
        textById("emailGateTitle", dict.email_gate_title);
        textById("emailGateCopy", dict.email_gate_copy);
        textById("emailGateLabel", dict.email_gate_label);
        textById("emailGateSubmit", dict.email_gate_submit);
        textById("emailGateCancel", dict.email_gate_cancel);

        placeholderById("fullName", dict.placeholder_name);
        placeholderById("contactBlock", dict.placeholder_contact);
        placeholderById("emailGateAddress", "name@goetheanum.ch");

        const btnPdf = document.getElementById("btnPdf");
        const btnSvg = document.getElementById("btnSvg");
        const btnPng = document.getElementById("btnPng");
        const btnSheetPdf = document.getElementById("btnSheetPdf");
        if (btnPdf) {
          btnPdf.setAttribute("data-tip", dict.tip_pdf);
        }
        if (btnSvg) {
          btnSvg.setAttribute("data-tip", dict.tip_svg);
        }
        if (btnPng) {
          btnPng.setAttribute("data-tip", dict.tip_png);
        }
        if (btnSheetPdf) {
          btnSheetPdf.setAttribute("data-tip", dict.tip_sheet);
        }

        populateOrgOptions(refs.schema.value);
        syncFormatControl(refs.schema.value);
        syncRolePlaceholders(refs.schema.value);
        syncOrgColorInfo();
        updateOwnerModeUi();
        renderAll();

        if (uiLangToggle) {
          uiLangToggle.querySelectorAll("button[data-uilang]").forEach(function (btn) {
            btn.classList.toggle("on", btn.getAttribute("data-uilang") === next);
          });
        }

        try {
          localStorage.setItem("vk_ui_lang", next);
        } catch (err) {
          // no-op
        }
      }

      function esc(value) {
        return String(value || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function normalizeOutlineWeight(weight) {
        const w = Number(weight) || 400;
        if (w >= 550) {
          return 600;
        }
        if (w <= 350) {
          return 300;
        }
        return 400;
      }

      function outlineFontForWeight(outlineFonts, weight) {
        if (!outlineFonts) {
          return null;
        }
        const normalized = normalizeOutlineWeight(weight);
        return (
          outlineFonts[String(normalized)] ||
          outlineFonts[normalized] ||
          outlineFonts["400"] ||
          outlineFonts[400] ||
          outlineFonts["600"] ||
          outlineFonts[600] ||
          outlineFonts["300"] ||
          outlineFonts[300] ||
          null
        );
      }

      function outlineGlyphAdvance(glyphSet, char, fontSize) {
        const glyph = glyphSet ? glyphSet[char] : null;
        if (glyph && typeof glyph.width === "number") {
          return glyph.width * (fontSize / TITILLIUM_OUTLINE_UPM);
        }
        return fontSize * 0.36;
      }

      function measureOutlineTextWidth(text, glyphSet, fontSize) {
        const raw = String(text || "");
        let width = 0;
        for (let i = 0; i < raw.length; i += 1) {
          width += outlineGlyphAdvance(glyphSet, raw[i], fontSize);
        }
        return width;
      }

      function outlinePathMarkupForText(text, x, y, fontSize, weight, anchor, fill, outlineFonts) {
        const raw = String(text || "");
        if (!raw) {
          return "";
        }
        const glyphSet = outlineFontForWeight(outlineFonts, weight);
        if (!glyphSet) {
          return "";
        }

        const scale = fontSize / TITILLIUM_OUTLINE_UPM;
        const advance = measureOutlineTextWidth(raw, glyphSet, fontSize);

        let startX = x;
        if (anchor === "middle") {
          startX = x - (advance / 2);
        } else if (anchor === "end") {
          startX = x - advance;
        }

        let currentX = startX;
        const parts = [];
        for (let i = 0; i < raw.length; i += 1) {
          const char = raw[i];
          const glyph = glyphSet[char];
          if (glyph && glyph.path) {
            parts.push(
              '<path d="' + esc(glyph.path) + '" transform="translate(' + currentX.toFixed(3) + " " + y.toFixed(3) + ") scale(" + scale.toFixed(6) + " " + (-scale).toFixed(6) + ')" />'
            );
          }
          currentX += outlineGlyphAdvance(glyphSet, char, fontSize);
        }
        if (!parts.length) {
          return "";
        }
        return '<g fill="' + esc(fill) + '">' + parts.join("") + "</g>";
      }

      function svgTextLineMarkup(params) {
        const line = String(params.text || "");
        const fill = esc(params.fill || "#000");
        const anchor = params.anchor || "end";
        const letterSpacing = typeof params.letterSpacing === "number" ? params.letterSpacing : null;
        const usePathText = Boolean(params.textAsPaths && params.outlineFonts);

        if (usePathText) {
          const pathMarkup = outlinePathMarkupForText(
            line,
            params.x,
            params.y,
            params.fontSize,
            params.fontWeight,
            anchor,
            fill,
            params.outlineFonts
          );
          if (pathMarkup) {
            return pathMarkup;
          }
        }

        const ls = letterSpacing !== null ? ' letter-spacing="' + letterSpacing + '"' : "";
        return (
          '<text x="' + params.x + '" y="' + params.y + '" text-anchor="' + anchor + '" fill="' + fill + '" font-family="Titillium-Upright, sans-serif" font-size="' + params.fontSize + '" font-weight="' + (params.fontWeight || 400) + '"' + ls + ">" +
            esc(line) +
          "</text>"
        );
      }

      function titilliumSvgFontDefs() {
        const style =
          "@font-face{font-family:'Titillium-Upright';font-style:normal;font-weight:300;src:url('assets/fonts/Titillium-LightUpright.otf') format('opentype');}" +
          "@font-face{font-family:'Titillium-Upright';font-style:normal;font-weight:400;src:url('assets/fonts/Titillium-RegularUpright.otf') format('opentype');}" +
          "@font-face{font-family:'Titillium-Upright';font-style:normal;font-weight:600;src:url('assets/fonts/Titillium-SemiboldUpright.otf') format('opentype');}" +
          "text{font-family:'Titillium-Upright',sans-serif;}";
        return "<defs><style><![CDATA[" + style + "]]></style></defs>";
      }

      async function ensureTitilliumOutlineFonts() {
        if (!TITILLIUM_OUTLINE_READY) {
          throw new Error("Titillium-Pfaddaten fehlen.");
        }
        return TITILLIUM_OUTLINE_GLYPHS;
      }

      function glyphAdvance(char, fontSize) {
        const glyph = GCI_GLYPHS[char];
        if (glyph && typeof glyph.width === "number") {
          return glyph.width * (fontSize / GCI_FONT_UPM);
        }
        return fontSize * 0.36;
      }

      function measureGlyphWidth(text, fontSize) {
        const raw = String(text || "");
        let width = 0;
        for (let i = 0; i < raw.length; i += 1) {
          width += glyphAdvance(raw[i], fontSize);
        }
        return width;
      }

      function glyphTextToPath(text, x, y, fontSize, anchor) {
        const raw = String(text || "");
        const scale = fontSize / GCI_FONT_UPM;
        const totalWidth = measureGlyphWidth(raw, fontSize);
        let currentX = x;
        if (anchor === "middle") {
          currentX = x - (totalWidth / 2);
        } else if (anchor === "end") {
          currentX = x - totalWidth;
        }
        const startX = currentX;
        const parts = [];
        for (let i = 0; i < raw.length; i += 1) {
          const char = raw[i];
          const glyph = GCI_GLYPHS[char];
          if (glyph && glyph.path) {
            parts.push(
              '<path d="' + glyph.path + '" transform="translate(' + currentX.toFixed(3) + " " + y.toFixed(3) + ") scale(" + scale.toFixed(6) + " " + (-scale).toFixed(6) + ')" />'
            );
          }
          currentX += glyphAdvance(char, fontSize);
        }
        return {
          width: totalWidth,
          startX: startX,
          paths: parts.join("")
        };
      }

      function splitLines(value) {
        return String(value || "")
          .split(/\r?\n/)
          .map((line) => line.trim())
          .filter(Boolean);
      }

      function toLineArray(value) {
        if (!value) {
          return [];
        }
        if (Array.isArray(value)) {
          return value.map(function (line) {
            return String(line).trim();
          }).filter(Boolean);
        }
        return splitLines(value);
      }

      function rolePlaceholderDeFor(schemaKey) {
        if (schemaKey === "bauadmin") {
          return "Administration des\nGoetheanum-Baues";
        }
        if (HOCHSCHULE_KEYS.indexOf(schemaKey) !== -1) {
          return sectionRoleLinesDe(schemaKey).join("\n");
        }
        const cat = categoryForSchema(schemaKey);
        if (cat === "bereiche") {
          return bereicheRoleLineDe(schemaKey);
        }
        if (schemaKey === "gesellschaft") {
          return toLineArray(EXAMPLE_PRESETS.gesellschaft.roleLinesDe).join("\n");
        }
        const dict = uiDict();
        return dict.placeholder_role || "";
      }

      function rolePlaceholderEnFor(schemaKey) {
        if (schemaKey === "bauadmin") {
          return "Administration of the Goetheanum Building";
        }
        if (HOCHSCHULE_KEYS.indexOf(schemaKey) !== -1) {
          return sectionRoleLinesEn(schemaKey).join("\n");
        }
        const cat = categoryForSchema(schemaKey);
        if (cat === "bereiche") {
          return bereicheRoleLineEn(schemaKey);
        }
        if (schemaKey === "gesellschaft") {
          return toLineArray(EXAMPLE_PRESETS.gesellschaft.roleLinesEn).join("\n");
        }
        const dict = uiDict();
        return dict.placeholder_role_en || "";
      }

      function syncRolePlaceholders(schemaKey) {
        const key = schemaKey || refs.schema.value;
        if (!key) {
          return;
        }
        placeholderById("roleBlock", rolePlaceholderDeFor(key));
        placeholderById("roleBlockEn", rolePlaceholderEnFor(key));
      }

      function defaultRoleLines(schemaKey) {
        const org = ORG_DEFS[schemaKey];
        if (!org) {
          return [];
        }
        const cat = categoryForSchema(schemaKey);
        if (cat === "gesellschaft") {
          return [org.name];
        }
        if (cat === "hochschule") {
          return ["Freie Hochschule für Geisteswissenschaft", org.name];
        }
        if (schemaKey === "bauadmin") {
          return ["Administration des", "Goetheanum-Baues"];
        }
        if (cat === "bereiche") {
          return [bereicheRoleLineDe(schemaKey)];
        }
        return [org.name];
      }

      function defaultContactLines(schemaKey) {
        const categoryKey = categoryForSchema(schemaKey);
        if (schemaKey === "bauadmin") {
          return [
            "Postfach · CH 4143 Dornach",
            "Telefon +41 61 706 4X XX",
            "name@goetheanum.ch"
          ];
        }
        if (categoryKey === "hochschule") {
          return [
            "Hügelweg 59 · 4143 Dornach",
            "Switzerland | +41 61 706 4X XX",
            "rudolf.steiner@goetheanum.ch",
            sectionWebsiteFor(schemaKey)
          ];
        }
        if (schemaKey === "gesellschaft") {
          return [
            "Hügelweg 59 · 4143 Dornach",
            "Switzerland | +41 61 706 4X XX",
            "rudolf.steiner@goetheanum.ch",
            "www.goetheanum.ch"
          ];
        }
        return [
          "Hügelweg 59 · 4143 Dornach",
          "Telefon +41 61 706 4X XX",
          "name@goetheanum.ch",
          "www.goetheanum.ch"
        ];
      }

      function categoryForSchema(schemaKey) {
        const keys = Object.keys(ORG_CATS);
        for (let i = 0; i < keys.length; i += 1) {
          const catKey = keys[i];
          const cat = ORG_CATS[catKey];
          if (cat && Array.isArray(cat.items) && cat.items.indexOf(schemaKey) !== -1) {
            return catKey;
          }
        }
        return null;
      }

      function symbolLabel(symbolSet) {
        if (currentUiLang === "en") {
          if (symbolSet === "bau") {
            return "Building Administration mark";
          }
          if (symbolSet === "icon") {
            return "Department logo (two-line)";
          }
          if (symbolSet === "hochschule") {
            return "School mark";
          }
          return "Society mark";
        }
        if (symbolSet === "bau") {
          return "Bau-Admin-Zeichen";
        }
        if (symbolSet === "icon") {
          return "Bereichslogo (zweizeilig)";
        }
        if (symbolSet === "hochschule") {
          return "Hochschulzeichen";
        }
        return "Gesellschaftszeichen";
      }

      function defaultSymbolForSchema(schemaKey) {
        if (schemaKey === "bauadmin") {
          return "bau";
        }
        const cat = categoryForSchema(schemaKey);
        if (cat === "bereiche") {
          return "icon";
        }
        if (cat === "hochschule") {
          return "hochschule";
        }
        return "gesellschaft";
      }

      function normalizedSymbolSet(symbolSet, schemaKey) {
        if (symbolSet === "gesellschaft" || symbolSet === "hochschule" || symbolSet === "icon" || symbolSet === "bau") {
          return symbolSet;
        }
        return defaultSymbolForSchema(schemaKey);
      }

      function supportsLandscapeFormat(schemaKey) {
        return categoryForSchema(schemaKey) === "bereiche";
      }

      function syncFormatControl(schemaKey) {
        if (!refs.cardFormat) {
          return;
        }
        const key = schemaKey || refs.schema.value;
        const landscapeAllowed = supportsLandscapeFormat(key);
        if (!landscapeAllowed && refs.cardFormat.value !== "portrait") {
          refs.cardFormat.value = "portrait";
        }
        refs.cardFormat.disabled = !landscapeAllowed;
      }

      function cardFormatForModel(model) {
        const desired = model && model.cardFormat === "landscape" ? "landscape" : "portrait";
        const key = model && model.schema ? model.schema : refs.schema.value;
        if (desired === "landscape" && supportsLandscapeFormat(key)) {
          return "landscape";
        }
        return "portrait";
      }

      function cardDimensionsMm(model) {
        const format = cardFormatForModel(model);
        if (format === "landscape") {
          return {
            widthMm: 85,
            heightMm: 55,
            format: "landscape"
          };
        }
        return {
          widthMm: 55,
          heightMm: 85,
          format: "portrait"
        };
      }

      function syncCardCssVars(model) {
        const dims = cardDimensionsMm(model);
        document.documentElement.style.setProperty("--card-w-mm", String(dims.widthMm));
        document.documentElement.style.setProperty("--card-h-mm", String(dims.heightMm));
      }

      function collectModel() {
        const schemaKey = refs.schema.value;
        const schemaOrg = ORG_DEFS[schemaKey];
        const roleLinesDe = splitLines(refs.roleBlock.value);
        const roleLinesEn = splitLines(refs.roleBlockEn.value);
        const roleLines = roleLinesDe.concat(roleLinesEn);
        const contactLines = splitLines(refs.contactBlock.value);
        const symbolSet = defaultSymbolForSchema(schemaKey);
        return {
          orgCategory: refs.orgCategory.value,
          schema: schemaKey,
          symbolSet: symbolSet,
          categoryKey: categoryForSchema(schemaKey) || refs.orgCategory.value,
          cardFormat: refs.cardFormat ? refs.cardFormat.value : "portrait",
          includeCrop: refs.includeCrop.checked,
          motifColor: schemaOrg ? schemaOrg.color : "#0061a9",
          textColor: CARD_DEFAULTS.textColor,
          bgColor: CARD_DEFAULTS.bgColor,
          fullName: refs.fullName.value.trim(),
          roleLinesDe: roleLinesDe,
          roleLinesEn: roleLinesEn,
          roleLines: roleLines,
          contactLines: contactLines
        };
      }

      function populateOrgOptions(preferredKey) {
        const catKey = refs.orgCategory.value;
        const cat = ORG_CATS[catKey];
        const items = cat ? cat.items : [];
        const previous = refs.schema.value;
        refs.schema.innerHTML = "";
        items.forEach((key) => {
          const org = ORG_DEFS[key];
          if (!org) {
            return;
          }
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = orgNameForUi(org);
          refs.schema.appendChild(opt);
        });
        const target = preferredKey && items.indexOf(preferredKey) !== -1 ? preferredKey : previous;
        if (target && items.indexOf(target) !== -1) {
          refs.schema.value = target;
        } else if (items.length) {
          refs.schema.value = items[0];
        }
      }

      function syncOrgColorInfo() {
        const org = ORG_DEFS[refs.schema.value];
        if (!org) {
          return;
        }
        refs.schema.setAttribute("data-color", org.color);
        refs.schema.title = org.color + " · " + orgNameForUi(org) + " · " + symbolLabel(defaultSymbolForSchema(refs.schema.value));
      }

      function applySchemaPreset(force) {
        const orgKey = refs.schema.value;
        const org = ORG_DEFS[orgKey];
        if (!org) {
          return;
        }
        const preset = examplePresetFor(orgKey);
        syncOrgColorInfo();

        const basePreset = preset || {
          fullName: "Vorname Nachname",
          roleLinesDe: defaultRoleLines(orgKey),
          roleLinesEn: [],
          contactLines: defaultContactLines(orgKey)
        };

        const roleLinesDe = toLineArray(basePreset.roleLinesDe);
        const roleLinesEn = toLineArray(basePreset.roleLinesEn);
        const fallbackRoleLines = toLineArray(basePreset.roleLines);

        const next = {
          fullName: basePreset.fullName || "Vorname Nachname",
          roleBlock: (roleLinesDe.length ? roleLinesDe : fallbackRoleLines).join("\n"),
          roleBlockEn: roleLinesEn.join("\n"),
          contactBlock: toLineArray(basePreset.contactLines).join("\n")
        };

        ["fullName", "roleBlock", "roleBlockEn", "contactBlock"].forEach((key) => {
          const input = refs[key];
          const current = String(input.value || "").trim();
          const previous = lastPreset ? String(lastPreset[key] || "").trim() : "";
          const forceEmptyEnPlaceholder =
            key === "roleBlockEn" &&
            !next[key] &&
            (categoryForSchema(orgKey) === "bereiche" || orgKey === "bauadmin");
          if (force || !current || current === previous || forceEmptyEnPlaceholder) {
            input.value = next[key];
          }
        });

        syncRolePlaceholders(orgKey);
        lastPreset = next;
      }

      function symbolSpecFor(symbolSet) {
        if (symbolSet === "bau") {
          return SYMBOL_LIBRARY.bau;
        }
        if (symbolSet === "hochschule") {
          return SYMBOL_LIBRARY.hochschule;
        }
        if (symbolSet === "gesellschaft") {
          return SYMBOL_LIBRARY.gesellschaft;
        }
        return SYMBOL_LIBRARY.icon;
      }

      function renderSymbolShapes(spec, color) {
        const fill = esc(color);
        const pathMarkup = (spec.paths || []).map(function (d) {
          return '<path d="' + d + '" fill="' + fill + '" />';
        }).join("");
        const polygonMarkup = (spec.polygons || []).map(function (points) {
          return '<polygon points="' + points + '" fill="' + fill + '" />';
        }).join("");
        return pathMarkup + polygonMarkup;
      }

      function bereicheLine2(schemaKey) {
        const org = ORG_DEFS[schemaKey];
        if (!org) {
          return "Bereich";
        }
        return org.label || org.name || "Bereich";
      }

      function buildBereicheHeaderData(color, textColor, schemaKey) {
        const line1 = "Goetheanum";
        const line2 = bereicheLine2(schemaKey);
        const fs = 10.3;
        const startX = 19.5;
        const width = Math.ceil(
          Math.max(
            measureGlyphWidth(line1, fs),
            measureGlyphWidth("Freiwilligenarbeit", fs)
          ) + 25
        );
        const height = 21;
        const line1Paths = glyphTextToPath(line1, startX, 10.05, fs, "start").paths;
        const line2Paths = glyphTextToPath(line2, startX, 20.05, fs, "start").paths;
        const iconParts = ICON_SIGN_PATHS.map(function (d) {
          return '<path d="' + d + '" fill="' + esc(color) + '" />';
        }).join("");
        return {
          width: width,
          height: height,
          content:
            iconParts +
            '<g fill="' + esc(textColor) + '">' + line1Paths + "</g>" +
            '<g fill="' + esc(color) + '">' + line2Paths + "</g>"
        };
      }

      function motifTypeForModel(model) {
        const categoryKey = model.categoryKey || categoryForSchema(model.schema);
        if (model.symbolSet === "bau") {
          return "bau";
        }
        if (categoryKey === "bereiche" && model.symbolSet === "icon") {
          return "bereiche";
        }
        return "sign";
      }

      function textLayoutFor(model, roleCount, contactCount) {
        const motifType = motifTypeForModel(model);
        const categoryKey = model.categoryKey || categoryForSchema(model.schema);
        const cardDims = cardDimensionsMm(model);
        const format = cardDims.format;
        const roleLines = Math.max(roleCount, 0);
        const contactLines = Math.max(contactCount, 0);

        let nameRightMm = 49.2;
        let bodyRightMm = 49.5;
        let lineLeadMm = 3.528;
        let nameSizeMm = 3.881;
        let roleSizeMm = 2.822;
        let contactSizeMm = 2.646;
        let roleWeight = 600;
        let maxLastContactBaselineMm = 76.980;
        let nameToRolesGapMm = 7.055;
        let rolesToContactGapMm = 7.056;

        if (motifType === "sign" && categoryKey === "hochschule") {
          nameRightMm = 49.45;
          bodyRightMm = 49.62;
          lineLeadMm = 3.528;
          nameSizeMm = 3.78;
          roleSizeMm = 2.86;
          contactSizeMm = 2.67;
          roleWeight = 400;
          maxLastContactBaselineMm = 76.95;
          nameToRolesGapMm = 6.35;
          rolesToContactGapMm = 7.2;
        } else if (motifType === "bau") {
          nameRightMm = 49.24;
          bodyRightMm = 49.56;
          lineLeadMm = 3.528;
          nameSizeMm = 3.881;
          roleSizeMm = 2.822;
          contactSizeMm = 2.646;
          roleWeight = 600;
          maxLastContactBaselineMm = 76.98;
          nameToRolesGapMm = 6.9;
          rolesToContactGapMm = 6.95;
        } else if (motifType === "bereiche") {
          nameRightMm = 49.2;
          bodyRightMm = 49.5;
          lineLeadMm = 3.528;
          nameSizeMm = 3.881;
          roleSizeMm = 2.822;
          contactSizeMm = 2.646;
          roleWeight = 600;
          maxLastContactBaselineMm = 76.98;
          nameToRolesGapMm = 7.055;
          rolesToContactGapMm = 7.056;
        }

        if (motifType === "bereiche" && format === "landscape") {
          nameRightMm = 77.95;
          bodyRightMm = 78.1;
          lineLeadMm = 3.34;
          nameSizeMm = 4.06;
          roleSizeMm = 2.96;
          contactSizeMm = 2.78;
          roleWeight = 600;
          maxLastContactBaselineMm = 46.8;
          nameToRolesGapMm = 5.35;
          rolesToContactGapMm = 5.55;
        }

        // Kontaktblock unten rechts fixieren: letzte Zeile bleibt an fester Baseline,
        // zusätzliche Zeilen wachsen nach oben.
        const contactStartBaselineMm = maxLastContactBaselineMm - (Math.max(contactLines, 1) - 1) * lineLeadMm;
        // Gesamttextblock kompakt von unten aufbauen:
        // Kontakt (unten) -> Rollen -> Name.
        const roleBlockSpanMm = Math.max(roleLines - 1, 0) * lineLeadMm;
        const rolesStartBaselineMm = contactStartBaselineMm - rolesToContactGapMm - roleBlockSpanMm;
        const nameBaselineMm = rolesStartBaselineMm - nameToRolesGapMm;

        return {
          nameRightMm: nameRightMm,
          bodyRightMm: bodyRightMm,
          nameBaselineMm: nameBaselineMm,
          rolesBaselineMm: rolesStartBaselineMm,
          contactBaselineMm: contactStartBaselineMm,
          lineLeadMm: lineLeadMm,
          nameSizeMm: nameSizeMm,
          roleSizeMm: roleSizeMm,
          contactSizeMm: contactSizeMm,
          roleWeight: roleWeight
        };
      }

      function roleWeightForLine(baseWeight, isEnglish) {
        return isEnglish ? 300 : baseWeight;
      }

      function renderCard(cardEl, model) {
        cardEl.style.setProperty("--card-bg", model.bgColor);
        cardEl.style.setProperty("--card-text", model.textColor);
        const svgMarkup = buildSvg(model, false)
          .replace(/^<\?xml[^>]*>\s*/i, "")
          .replace("<svg ", '<svg class="card-svg" ');
        cardEl.innerHTML = svgMarkup;
      }

      function motifBoxMmFor(motifType, model) {
        const dims = cardDimensionsMm(model);
        if (motifType === "bau") {
          return { x: 5.24, y: 4.76, w: 42.76, h: 43.72 };
        }
        if (motifType === "bereiche") {
          if (dims.format === "landscape") {
            return { x: 4.9, y: 4.9, w: 34.32, h: 9.68 };
          }
          return { x: 5.8, y: 4.9, w: 38.4, h: 11.4 };
        }
        return { x: 5.27, y: 5.06, w: 22.14, h: 36.93 };
      }

      function buildSvg(model, withCrop, options) {
        const svgOptions = options || {};
        const outlineFonts = svgOptions.outlineFonts || null;
        const textAsPaths = Boolean(svgOptions.textAsPaths && outlineFonts);
        const unit = 10;
        const dims = cardDimensionsMm(model);
        const cardW = dims.widthMm * unit;
        const cardH = dims.heightMm * unit;
        const bleed = withCrop ? 3 * unit : 0;
        const totalW = cardW + (bleed * 2);
        const totalH = cardH + (bleed * 2);
        const ox = bleed;
        const oy = bleed;
        const mm = function (value) {
          return value * unit;
        };

        const symbolSet = normalizedSymbolSet(model.symbolSet, model.schema);
        const motifType = motifTypeForModel({
          schema: model.schema,
          categoryKey: model.categoryKey,
          symbolSet: symbolSet
        });
        const roleLinesDe = toLineArray(model.roleLinesDe);
        const roleLinesEn = toLineArray(model.roleLinesEn);
        const hasSplitRoleBlocks = roleLinesDe.length > 0 || roleLinesEn.length > 0;
        const roleLines = hasSplitRoleBlocks ? roleLinesDe.concat(roleLinesEn) : toLineArray(model.roleLines);
        const contactLines = toLineArray(model.contactLines);
        const name = model.fullName || "Vorname Nachname";
        const textLayout = textLayoutFor(model, roleLines.length, contactLines.length);
        const motifBox = motifBoxMmFor(motifType, model);
        const schemaDef = ORG_DEFS[model.schema];

        function motifSvg() {
          if (motifType === "bereiche") {
            const header = buildBereicheHeaderData(model.motifColor, model.textColor, model.schema);
            return (
              '<svg x="' + (ox + mm(motifBox.x)) + '" y="' + (oy + mm(motifBox.y)) + '" width="' + mm(motifBox.w) + '" height="' + mm(motifBox.h) + '" viewBox="0 0 ' + header.width + " " + header.height + '" preserveAspectRatio="xMinYMin meet">' +
                header.content +
              "</svg>"
            );
          }
          const spec = symbolSpecFor(symbolSet);
          return (
            '<svg x="' + (ox + mm(motifBox.x)) + '" y="' + (oy + mm(motifBox.y)) + '" width="' + mm(motifBox.w) + '" height="' + mm(motifBox.h) + '" viewBox="' + esc(spec.viewBox) + '" preserveAspectRatio="xMinYMin meet">' +
              renderSymbolShapes(spec, model.motifColor) +
            "</svg>"
          );
        }

        const nameAnchorX = ox + mm(textLayout.nameRightMm);
        const bodyAnchorX = ox + mm(textLayout.bodyRightMm);
        const nameY = oy + mm(textLayout.nameBaselineMm);
        let textParts = "";
        textParts += svgTextLineMarkup({
          text: name,
          x: nameAnchorX,
          y: nameY,
          fontSize: mm(textLayout.nameSizeMm),
          fontWeight: 600,
          fill: model.textColor,
          anchor: "end",
          letterSpacing: 0.006,
          textAsPaths: textAsPaths,
          outlineFonts: outlineFonts
        });

        if (hasSplitRoleBlocks) {
          let roleIndex = 0;
          roleLinesDe.forEach(function (line) {
            const y = oy + mm(textLayout.rolesBaselineMm + (textLayout.lineLeadMm * roleIndex));
            const w = roleWeightForLine(textLayout.roleWeight, false);
            textParts += svgTextLineMarkup({
              text: line,
              x: bodyAnchorX,
              y: y,
              fontSize: mm(textLayout.roleSizeMm),
              fontWeight: w,
              fill: model.textColor,
              anchor: "end",
              letterSpacing: 0.004,
              textAsPaths: textAsPaths,
              outlineFonts: outlineFonts
            });
            roleIndex += 1;
          });
          roleLinesEn.forEach(function (line) {
            const y = oy + mm(textLayout.rolesBaselineMm + (textLayout.lineLeadMm * roleIndex));
            const w = roleWeightForLine(textLayout.roleWeight, true);
            textParts += svgTextLineMarkup({
              text: line,
              x: bodyAnchorX,
              y: y,
              fontSize: mm(textLayout.roleSizeMm),
              fontWeight: w,
              fill: model.textColor,
              anchor: "end",
              letterSpacing: 0.004,
              textAsPaths: textAsPaths,
              outlineFonts: outlineFonts
            });
            roleIndex += 1;
          });
        } else {
          roleLines.forEach(function (line, index) {
            const y = oy + mm(textLayout.rolesBaselineMm + (textLayout.lineLeadMm * index));
            const w = roleWeightForLine(textLayout.roleWeight, false);
            textParts += svgTextLineMarkup({
              text: line,
              x: bodyAnchorX,
              y: y,
              fontSize: mm(textLayout.roleSizeMm),
              fontWeight: w,
              fill: model.textColor,
              anchor: "end",
              letterSpacing: 0.004,
              textAsPaths: textAsPaths,
              outlineFonts: outlineFonts
            });
          });
        }

        for (let i = 0; i < contactLines.length; i += 1) {
          const y = oy + mm(textLayout.contactBaselineMm + (i * textLayout.lineLeadMm));
          textParts += svgTextLineMarkup({
            text: contactLines[i],
            x: bodyAnchorX,
            y: y,
            fontSize: mm(textLayout.contactSizeMm),
            fontWeight: 400,
            fill: model.textColor,
            anchor: "end",
            letterSpacing: 0.004,
            textAsPaths: textAsPaths,
            outlineFonts: outlineFonts
          });
        }

        if (!roleLines.length && !contactLines.length) {
          textParts += svgTextLineMarkup({
            text: schemaDef ? schemaDef.name : "",
            x: bodyAnchorX,
            y: (oy + mm(textLayout.rolesBaselineMm)),
            fontSize: mm(textLayout.roleSizeMm),
            fontWeight: textLayout.roleWeight,
            fill: model.textColor,
            anchor: "end",
            letterSpacing: 0.004,
            textAsPaths: textAsPaths,
            outlineFonts: outlineFonts
          });
        }

        const cropElements = withCrop
          ? (
              '<line x1="' + (ox - 30) + '" y1="' + oy + '" x2="' + (ox - 2) + '" y2="' + oy + '" stroke="#111" stroke-width="2" />' +
              '<line x1="' + ox + '" y1="' + (oy - 30) + '" x2="' + ox + '" y2="' + (oy - 2) + '" stroke="#111" stroke-width="2" />' +
              '<line x1="' + (ox + cardW + 2) + '" y1="' + oy + '" x2="' + (ox + cardW + 30) + '" y2="' + oy + '" stroke="#111" stroke-width="2" />' +
              '<line x1="' + (ox + cardW) + '" y1="' + (oy - 30) + '" x2="' + (ox + cardW) + '" y2="' + (oy - 2) + '" stroke="#111" stroke-width="2" />' +
              '<line x1="' + (ox - 30) + '" y1="' + (oy + cardH) + '" x2="' + (ox - 2) + '" y2="' + (oy + cardH) + '" stroke="#111" stroke-width="2" />' +
              '<line x1="' + ox + '" y1="' + (oy + cardH + 2) + '" x2="' + ox + '" y2="' + (oy + cardH + 30) + '" stroke="#111" stroke-width="2" />' +
              '<line x1="' + (ox + cardW + 2) + '" y1="' + (oy + cardH) + '" x2="' + (ox + cardW + 30) + '" y2="' + (oy + cardH) + '" stroke="#111" stroke-width="2" />' +
              '<line x1="' + (ox + cardW) + '" y1="' + (oy + cardH + 2) + '" x2="' + (ox + cardW) + '" y2="' + (oy + cardH + 30) + '" stroke="#111" stroke-width="2" />'
            )
          : "";

        return (
          '<?xml version="1.0" encoding="UTF-8"?>\n' +
          '<svg xmlns="http://www.w3.org/2000/svg" width="' + (totalW / unit) + 'mm" height="' + (totalH / unit) + 'mm" viewBox="0 0 ' + totalW + " " + totalH + '">' +
            titilliumSvgFontDefs() +
            '<rect x="' + ox + '" y="' + oy + '" width="' + cardW + '" height="' + cardH + '" fill="' + esc(model.bgColor) + '" />' +
            motifSvg() +
            textParts +
            cropElements +
          "</svg>"
        );
      }

      function downloadBlob(blob, name) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        setTimeout(function () {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 50);
      }

      function mmToPt(mmValue) {
        return (mmValue / 25.4) * 72;
      }

      function pageSizeMm(model) {
        const dims = cardDimensionsMm(model);
        const bleed = model.includeCrop ? 3 : 0;
        return {
          widthMm: dims.widthMm + (bleed * 2),
          heightMm: dims.heightMm + (bleed * 2)
        };
      }

      function pageSizePx(model, dpi) {
        const sizeMm = pageSizeMm(model);
        return {
          widthPx: Math.max(1, Math.round((sizeMm.widthMm / 25.4) * dpi)),
          heightPx: Math.max(1, Math.round((sizeMm.heightMm / 25.4) * dpi)),
          widthMm: sizeMm.widthMm,
          heightMm: sizeMm.heightMm
        };
      }

      function base64ToUint8Array(base64) {
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i += 1) {
          bytes[i] = binary.charCodeAt(i);
        }
        return bytes;
      }

      function concatUint8(chunks) {
        const total = chunks.reduce(function (sum, part) {
          return sum + part.length;
        }, 0);
        const out = new Uint8Array(total);
        let offset = 0;
        chunks.forEach(function (part) {
          out.set(part, offset);
          offset += part.length;
        });
        return out;
      }

      function svgToImage(svgMarkup) {
        return new Promise(function (resolve, reject) {
          const blob = new Blob([svgMarkup], { type: "image/svg+xml;charset=utf-8" });
          const url = URL.createObjectURL(blob);
          const img = new Image();
          img.onload = function () {
            URL.revokeObjectURL(url);
            resolve(img);
          };
          img.onerror = function () {
            URL.revokeObjectURL(url);
            reject(new Error("SVG konnte nicht gerendert werden."));
          };
          img.src = url;
        });
      }

      async function ensureTitilliumReady() {
        if (!document.fonts || !document.fonts.load) {
          return;
        }
        try {
          await Promise.all([
            document.fonts.load('300 16px "Titillium-Upright"'),
            document.fonts.load('400 16px "Titillium-Upright"'),
            document.fonts.load('600 16px "Titillium-Upright"')
          ]);
        } catch (err) {
          // no-op
        }
      }

      async function drawMotifOnCanvas(ctx, model, ox, oy, pxPerMm) {
        const symbolSet = normalizedSymbolSet(model.symbolSet, model.schema);
        const motifType = motifTypeForModel({
          schema: model.schema,
          categoryKey: model.categoryKey,
          symbolSet: symbolSet
        });
        const motifBox = motifBoxMmFor(motifType, model);
        let motifSvg = "";

        if (motifType === "bereiche") {
          const header = buildBereicheHeaderData(model.motifColor, model.textColor, model.schema);
          motifSvg =
            '<?xml version="1.0" encoding="UTF-8"?>' +
            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ' + header.width + " " + header.height + '">' +
              header.content +
            "</svg>";
        } else {
          const spec = symbolSpecFor(symbolSet);
          motifSvg =
            '<?xml version="1.0" encoding="UTF-8"?>' +
            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="' + esc(spec.viewBox) + '">' +
              renderSymbolShapes(spec, model.motifColor) +
            "</svg>";
        }

        const img = await svgToImage(motifSvg);
        ctx.drawImage(
          img,
          ox + (motifBox.x * pxPerMm),
          oy + (motifBox.y * pxPerMm),
          motifBox.w * pxPerMm,
          motifBox.h * pxPerMm
        );
      }

      function drawCardTextOnCanvas(ctx, model, ox, oy, pxPerMm) {
        const roleLinesDe = toLineArray(model.roleLinesDe);
        const roleLinesEn = toLineArray(model.roleLinesEn);
        const hasSplitRoleBlocks = roleLinesDe.length > 0 || roleLinesEn.length > 0;
        const roleLines = hasSplitRoleBlocks ? roleLinesDe.concat(roleLinesEn) : toLineArray(model.roleLines);
        const contactLines = toLineArray(model.contactLines);
        const layout = textLayoutFor(model, roleLines.length, contactLines.length);
        const bodyRightX = ox + (layout.bodyRightMm * pxPerMm);
        const nameRightX = ox + (layout.nameRightMm * pxPerMm);
        const name = model.fullName || "Vorname Nachname";

        ctx.save();
        ctx.fillStyle = model.textColor;
        ctx.textAlign = "right";
        ctx.textBaseline = "alphabetic";

        ctx.font = "600 " + (layout.nameSizeMm * pxPerMm).toFixed(3) + 'px "Titillium-Upright", sans-serif';
        ctx.fillText(name, nameRightX, oy + (layout.nameBaselineMm * pxPerMm));

        if (hasSplitRoleBlocks) {
          let roleIndex = 0;
          roleLinesDe.forEach(function (line) {
            const y = oy + ((layout.rolesBaselineMm + (roleIndex * layout.lineLeadMm)) * pxPerMm);
            const w = roleWeightForLine(layout.roleWeight, false);
            ctx.font = w + " " + (layout.roleSizeMm * pxPerMm).toFixed(3) + 'px "Titillium-Upright", sans-serif';
            ctx.fillText(line, bodyRightX, y);
            roleIndex += 1;
          });
          roleLinesEn.forEach(function (line) {
            const y = oy + ((layout.rolesBaselineMm + (roleIndex * layout.lineLeadMm)) * pxPerMm);
            const w = roleWeightForLine(layout.roleWeight, true);
            ctx.font = w + " " + (layout.roleSizeMm * pxPerMm).toFixed(3) + 'px "Titillium-Upright", sans-serif';
            ctx.fillText(line, bodyRightX, y);
            roleIndex += 1;
          });
        } else {
          roleLines.forEach(function (line, index) {
            const y = oy + ((layout.rolesBaselineMm + (index * layout.lineLeadMm)) * pxPerMm);
            const w = roleWeightForLine(layout.roleWeight, false);
            ctx.font = w + " " + (layout.roleSizeMm * pxPerMm).toFixed(3) + 'px "Titillium-Upright", sans-serif';
            ctx.fillText(line, bodyRightX, y);
          });
        }

        ctx.font = "400 " + (layout.contactSizeMm * pxPerMm).toFixed(3) + 'px "Titillium-Upright", sans-serif';
        contactLines.forEach(function (line, index) {
          const y = oy + ((layout.contactBaselineMm + (index * layout.lineLeadMm)) * pxPerMm);
          ctx.fillText(line, bodyRightX, y);
        });

        if (!roleLines.length && !contactLines.length) {
          const org = ORG_DEFS[model.schema];
          ctx.font = layout.roleWeight + " " + (layout.roleSizeMm * pxPerMm).toFixed(3) + 'px "Titillium-Upright", sans-serif';
          ctx.fillText(org ? org.name : "", bodyRightX, oy + (layout.rolesBaselineMm * pxPerMm));
        }
        ctx.restore();
      }

      function drawCropMarksOnCanvas(ctx, ox, oy, cardWpx, cardHpx, pxPerMm) {
        const markLen = 2.8 * pxPerMm;
        const off = 0.2 * pxPerMm;
        ctx.save();
        ctx.strokeStyle = "#111";
        ctx.lineWidth = Math.max(1, Math.round(0.2 * pxPerMm));

        ctx.beginPath();
        ctx.moveTo(ox - markLen, oy);
        ctx.lineTo(ox - off, oy);
        ctx.moveTo(ox, oy - markLen);
        ctx.lineTo(ox, oy - off);
        ctx.moveTo(ox + cardWpx + off, oy);
        ctx.lineTo(ox + cardWpx + markLen, oy);
        ctx.moveTo(ox + cardWpx, oy - markLen);
        ctx.lineTo(ox + cardWpx, oy - off);

        ctx.moveTo(ox - markLen, oy + cardHpx);
        ctx.lineTo(ox - off, oy + cardHpx);
        ctx.moveTo(ox, oy + cardHpx + off);
        ctx.lineTo(ox, oy + cardHpx + markLen);
        ctx.moveTo(ox + cardWpx + off, oy + cardHpx);
        ctx.lineTo(ox + cardWpx + markLen, oy + cardHpx);
        ctx.moveTo(ox + cardWpx, oy + cardHpx + off);
        ctx.lineTo(ox + cardWpx, oy + cardHpx + markLen);
        ctx.stroke();
        ctx.restore();
      }

      async function renderModelToCanvas(model, dpi) {
        const size = pageSizePx(model, dpi);
        const pxPerMm = dpi / 25.4;
        const bleedMm = model.includeCrop ? 3 : 0;
        const dims = cardDimensionsMm(model);
        const ox = bleedMm * pxPerMm;
        const oy = bleedMm * pxPerMm;
        const cardWpx = dims.widthMm * pxPerMm;
        const cardHpx = dims.heightMm * pxPerMm;

        await ensureTitilliumReady();
        const canvas = document.createElement("canvas");
        canvas.width = size.widthPx;
        canvas.height = size.heightPx;
        const ctx = canvas.getContext("2d", { alpha: false });
        if (!ctx) {
          throw new Error("Canvas-Kontext konnte nicht erstellt werden.");
        }
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";

        ctx.fillStyle = model.bgColor;
        ctx.fillRect(ox, oy, cardWpx, cardHpx);
        await drawMotifOnCanvas(ctx, model, ox, oy, pxPerMm);
        drawCardTextOnCanvas(ctx, model, ox, oy, pxPerMm);

        if (model.includeCrop) {
          drawCropMarksOnCanvas(ctx, ox, oy, cardWpx, cardHpx, pxPerMm);
        }
        return {
          canvas: canvas,
          size: size
        };
      }

      function canvasToBlob(canvas, mimeType, quality) {
        return new Promise(function (resolve, reject) {
          if (!canvas.toBlob) {
            try {
              const dataUrl = canvas.toDataURL(mimeType, quality);
              const base64 = dataUrl.split(",")[1] || "";
              resolve(new Blob([base64ToUint8Array(base64)], { type: mimeType }));
            } catch (err) {
              reject(err);
            }
            return;
          }
          canvas.toBlob(function (blob) {
            if (!blob) {
              reject(new Error("Bilddatei konnte nicht erzeugt werden."));
              return;
            }
            resolve(blob);
          }, mimeType, quality);
        });
      }

      function buildExportBaseName(model) {
        const raw = String(model.schema || "karte").toLowerCase();
        const schema = raw.replace(/[^a-z0-9_-]+/g, "-").replace(/^-+|-+$/g, "") || "karte";
        const formatSuffix = cardDimensionsMm(model).format === "landscape" ? "_quer" : "";
        return "visitenkarte_" + schema + formatSuffix + (model.includeCrop ? "_mit-schnittmarken" : "");
      }

      function buildPdfBlobFromJpeg(jpegBytes, imageWidthPx, imageHeightPx, pageWidthPt, pageHeightPt) {
        const encoder = new TextEncoder();
        const chunks = [];
        const xref = [0];
        let offset = 0;

        function pushBytes(bytes) {
          chunks.push(bytes);
          offset += bytes.length;
        }

        function pushText(text) {
          pushBytes(encoder.encode(text));
        }

        function markObject(number) {
          xref[number] = offset;
        }

        const contentText =
          "q\n" +
          pageWidthPt.toFixed(3) + " 0 0 " + pageHeightPt.toFixed(3) + " 0 0 cm\n" +
          "/Im0 Do\nQ\n";
        const contentBytes = encoder.encode(contentText);

        pushText("%PDF-1.4\n");

        markObject(1);
        pushText("1 0 obj\n<< /Type /Catalog /Pages 2 0 R >>\nendobj\n");

        markObject(2);
        pushText("2 0 obj\n<< /Type /Pages /Kids [3 0 R] /Count 1 >>\nendobj\n");

        markObject(3);
        pushText(
          "3 0 obj\n<< /Type /Page /Parent 2 0 R /MediaBox [0 0 " +
            pageWidthPt.toFixed(3) + " " + pageHeightPt.toFixed(3) +
            "] /Resources << /XObject << /Im0 4 0 R >> >> /Contents 5 0 R >>\nendobj\n"
        );

        markObject(4);
        pushText(
          "4 0 obj\n<< /Type /XObject /Subtype /Image /Width " + imageWidthPx +
            " /Height " + imageHeightPx +
            " /ColorSpace /DeviceRGB /BitsPerComponent 8 /Filter /DCTDecode /Length " + jpegBytes.length +
            " >>\nstream\n"
        );
        pushBytes(jpegBytes);
        pushText("\nendstream\nendobj\n");

        markObject(5);
        pushText("5 0 obj\n<< /Length " + contentBytes.length + " >>\nstream\n");
        pushBytes(contentBytes);
        pushText("endstream\nendobj\n");

        const xrefOffset = offset;
        pushText("xref\n0 6\n0000000000 65535 f \n");
        for (let i = 1; i <= 5; i += 1) {
          pushText(String(xref[i]).padStart(10, "0") + " 00000 n \n");
        }
        pushText("trailer\n<< /Size 6 /Root 1 0 R >>\nstartxref\n" + xrefOffset + "\n%%EOF");

        return new Blob([concatUint8(chunks)], { type: "application/pdf" });
      }

      function canvasToRgbBytes(canvas) {
        const ctx = canvas.getContext("2d", { alpha: false });
        if (!ctx) {
          throw new Error("Canvas-Kontext für RGB-Export konnte nicht erstellt werden.");
        }
        const rgba = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        const rgb = new Uint8Array(canvas.width * canvas.height * 3);
        for (let i = 0, j = 0; i < rgba.length; i += 4) {
          rgb[j] = rgba[i];
          rgb[j + 1] = rgba[i + 1];
          rgb[j + 2] = rgba[i + 2];
          j += 3;
        }
        return rgb;
      }

      function buildPdfBlobFromRgb(rgbBytes, imageWidthPx, imageHeightPx, pageWidthPt, pageHeightPt) {
        const encoder = new TextEncoder();
        const chunks = [];
        const xref = [0];
        let offset = 0;

        function pushBytes(bytes) {
          chunks.push(bytes);
          offset += bytes.length;
        }

        function pushText(text) {
          pushBytes(encoder.encode(text));
        }

        function markObject(number) {
          xref[number] = offset;
        }

        const contentText =
          "q\n" +
          pageWidthPt.toFixed(3) + " 0 0 " + pageHeightPt.toFixed(3) + " 0 0 cm\n" +
          "/Im0 Do\nQ\n";
        const contentBytes = encoder.encode(contentText);

        pushText("%PDF-1.4\n");

        markObject(1);
        pushText("1 0 obj\n<< /Type /Catalog /Pages 2 0 R >>\nendobj\n");

        markObject(2);
        pushText("2 0 obj\n<< /Type /Pages /Kids [3 0 R] /Count 1 >>\nendobj\n");

        markObject(3);
        pushText(
          "3 0 obj\n<< /Type /Page /Parent 2 0 R /MediaBox [0 0 " +
            pageWidthPt.toFixed(3) + " " + pageHeightPt.toFixed(3) +
            "] /Resources << /XObject << /Im0 4 0 R >> >> /Contents 5 0 R >>\nendobj\n"
        );

        markObject(4);
        pushText(
          "4 0 obj\n<< /Type /XObject /Subtype /Image /Width " + imageWidthPx +
            " /Height " + imageHeightPx +
            " /ColorSpace /DeviceRGB /BitsPerComponent 8 /Interpolate false /Length " + rgbBytes.length +
            " >>\nstream\n"
        );
        pushBytes(rgbBytes);
        pushText("\nendstream\nendobj\n");

        markObject(5);
        pushText("5 0 obj\n<< /Length " + contentBytes.length + " >>\nstream\n");
        pushBytes(contentBytes);
        pushText("endstream\nendobj\n");

        const xrefOffset = offset;
        pushText("xref\n0 6\n0000000000 65535 f \n");
        for (let i = 1; i <= 5; i += 1) {
          pushText(String(xref[i]).padStart(10, "0") + " 00000 n \n");
        }
        pushText("trailer\n<< /Size 6 /Root 1 0 R >>\nstartxref\n" + xrefOffset + "\n%%EOF");

        return new Blob([concatUint8(chunks)], { type: "application/pdf" });
      }

      let pdfLibLoadPromise = null;
      function loadExternalScriptOnce(src) {
        return new Promise(function (resolve, reject) {
          const existing = document.querySelector('script[data-external-src="' + src + '"]');
          if (existing) {
            if (existing.getAttribute("data-loaded") === "1") {
              resolve();
              return;
            }
            existing.addEventListener("load", function () {
              resolve();
            }, { once: true });
            existing.addEventListener("error", function () {
              reject(new Error("Script konnte nicht geladen werden: " + src));
            }, { once: true });
            return;
          }
          const script = document.createElement("script");
          script.src = src;
          script.async = true;
          script.defer = true;
          script.setAttribute("data-external-src", src);
          script.addEventListener("load", function () {
            script.setAttribute("data-loaded", "1");
            resolve();
          }, { once: true });
          script.addEventListener("error", function () {
            reject(new Error("Script konnte nicht geladen werden: " + src));
          }, { once: true });
          document.head.appendChild(script);
        });
      }

      async function loadExternalScriptAny(sources) {
        const urls = Array.isArray(sources) ? sources : [sources];
        let lastError = null;
        for (let i = 0; i < urls.length; i += 1) {
          try {
            await loadExternalScriptOnce(urls[i]);
            return;
          } catch (err) {
            lastError = err;
          }
        }
        throw (lastError || new Error("Script konnte nicht geladen werden."));
      }

      async function ensureVectorPdfLibs() {
        const hasVectorApi = function () {
          return Boolean(
            window.jspdf &&
            window.jspdf.jsPDF &&
            window.jspdf.jsPDF.API &&
            typeof window.jspdf.jsPDF.API.svg === "function"
          );
        };

        if (hasVectorApi()) {
          return;
        }
        if (!pdfLibLoadPromise) {
          pdfLibLoadPromise = (async function () {
            await loadExternalScriptAny([
              "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",
              "https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js",
              "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
            ]);
            await loadExternalScriptAny([
              "https://cdn.jsdelivr.net/npm/svg2pdf.js@2.2.3/dist/svg2pdf.umd.min.js",
              "https://unpkg.com/svg2pdf.js@2.2.3/dist/svg2pdf.umd.min.js",
              "https://cdnjs.cloudflare.com/ajax/libs/svg2pdf.js/2.2.3/svg2pdf.umd.min.js"
            ]);
          })();
        }
        await pdfLibLoadPromise;
        if (!hasVectorApi()) {
          throw new Error("Vector-PDF-Bibliotheken nicht verfügbar.");
        }
      }

      async function withExportState(buttonId, workingText, runner) {
        const btn = document.getElementById(buttonId);
        const label = btn ? btn.textContent : "";
        if (btn) {
          btn.disabled = true;
          btn.textContent = workingText;
        }
        try {
          await runner();
        } catch (err) {
          console.error(err);
          alert("Export fehlgeschlagen. Bitte erneut versuchen.");
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.textContent = label;
          }
        }
      }

      async function exportPng(model, dpi) {
        const rendered = await renderModelToCanvas(model, dpi);
        const canvas = rendered.canvas;
        const pngBlob = await canvasToBlob(canvas, "image/png");
        downloadBlob(pngBlob, buildExportBaseName(model) + "_" + dpi + "dpi.png");
      }

      async function exportPdf(model) {
        const pdfModel = Object.assign({}, model, {
          includeCrop: false
        });
        const dims = cardDimensionsMm(pdfModel);
        const fileName = buildExportBaseName(pdfModel) + ".pdf";
        try {
          await ensureVectorPdfLibs();
          const outlineFonts = await ensureTitilliumOutlineFonts();
          const JsPdf = window.jspdf.jsPDF;
          const doc = new JsPdf({
            orientation: dims.widthMm > dims.heightMm ? "landscape" : "portrait",
            unit: "mm",
            format: [dims.widthMm, dims.heightMm],
            compress: true,
            putOnlyUsedFonts: true,
            precision: 12
          });
          const svgMarkup = buildSvg(pdfModel, false, {
            textAsPaths: true,
            outlineFonts: outlineFonts
          });
          const parsed = new DOMParser().parseFromString(svgMarkup, "image/svg+xml");
          const svgRoot = parsed.documentElement;
          if (!svgRoot || svgRoot.nodeName.toLowerCase() !== "svg") {
            throw new Error("SVG konnte für Vektor-PDF nicht gelesen werden.");
          }
          await doc.svg(svgRoot, {
            x: 0,
            y: 0,
            width: dims.widthMm,
            height: dims.heightMm
          });
          const vectorBlob = doc.output("blob");
          if (!vectorBlob || !vectorBlob.size) {
            throw new Error("Vektor-PDF-Ausgabe leer.");
          }
          downloadBlob(vectorBlob, fileName);
          return;
        } catch (err) {
          console.warn("Vektor-PDF fehlgeschlagen, fallback auf Raster-PDF.", err);
        }

        const dpi = 600;
        const rendered = await renderModelToCanvas(pdfModel, dpi);
        const canvas = rendered.canvas;
        const size = rendered.size;
        const rgbBytes = canvasToRgbBytes(canvas);
        const pdfBlob = buildPdfBlobFromRgb(
          rgbBytes,
          size.widthPx,
          size.heightPx,
          mmToPt(size.widthMm),
          mmToPt(size.heightMm)
        );
        downloadBlob(pdfBlob, fileName);
      }

      function fitCardsOnSheet(tileW, tileH, sheetW, sheetH, outerMarginPx) {
        const usableW = Math.max(tileW, sheetW - (outerMarginPx * 2));
        const usableH = Math.max(tileH, sheetH - (outerMarginPx * 2));
        const cols = Math.max(1, Math.floor(usableW / tileW));
        const rows = Math.max(1, Math.floor(usableH / tileH));
        const usedW = cols * tileW;
        const usedH = rows * tileH;
        return {
          cols: cols,
          rows: rows,
          count: cols * rows,
          usedW: usedW,
          usedH: usedH,
          offsetX: Math.floor((sheetW - usedW) / 2),
          offsetY: Math.floor((sheetH - usedH) / 2),
          rotate: false
        };
      }

      function chooseSheetLayout(tileW, tileH, sheetW, sheetH, outerMarginPx) {
        return fitCardsOnSheet(tileW, tileH, sheetW, sheetH, outerMarginPx);
      }

      function drawSheetGridMarks(ctx, layout, originX, originY, tileW, tileH, pxPerMm) {
        const markLen = 3.2 * pxPerMm;
        const off = 0.3 * pxPerMm;
        const x1 = originX + (layout.cols * tileW);
        const y1 = originY + (layout.rows * tileH);

        ctx.save();
        ctx.strokeStyle = "#111";
        ctx.lineWidth = Math.max(1, Math.round(0.18 * pxPerMm));
        ctx.beginPath();

        for (let col = 0; col <= layout.cols; col += 1) {
          const x = originX + (col * tileW);
          ctx.moveTo(x, originY - markLen);
          ctx.lineTo(x, originY - off);
          ctx.moveTo(x, y1 + off);
          ctx.lineTo(x, y1 + markLen);
        }

        for (let row = 0; row <= layout.rows; row += 1) {
          const y = originY + (row * tileH);
          ctx.moveTo(originX - markLen, y);
          ctx.lineTo(originX - off, y);
          ctx.moveTo(x1 + off, y);
          ctx.lineTo(x1 + markLen, y);
        }

        ctx.stroke();
        ctx.restore();
      }

      function drawSheetGridMarksPdf(doc, layout, originX, originY, tileW, tileH) {
        const markLen = 3.2;
        const off = 0.3;
        const x1 = originX + (layout.cols * tileW);
        const y1 = originY + (layout.rows * tileH);

        doc.setDrawColor(17, 17, 17);
        doc.setLineWidth(0.15);

        for (let col = 0; col <= layout.cols; col += 1) {
          const x = originX + (col * tileW);
          doc.line(x, originY - markLen, x, originY - off);
          doc.line(x, y1 + off, x, y1 + markLen);
        }

        for (let row = 0; row <= layout.rows; row += 1) {
          const y = originY + (row * tileH);
          doc.line(originX - markLen, y, originX - off, y);
          doc.line(x1 + off, y, x1 + markLen, y);
        }
      }

      async function renderSheetCanvas(model, dpi) {
        const a4wMm = 210;
        const a4hMm = 297;
        const sheetW = Math.max(1, Math.round((a4wMm / 25.4) * dpi));
        const sheetH = Math.max(1, Math.round((a4hMm / 25.4) * dpi));
        const outerMarginPx = Math.max(1, Math.round((4 / 25.4) * dpi));
        const tileModel = Object.assign({}, model, {
          includeCrop: false,
          bgColor: "#ffffff"
        });
        const tileRender = await renderModelToCanvas(tileModel, dpi);
        const tileCanvas = tileRender.canvas;
        const tileW = tileCanvas.width;
        const tileH = tileCanvas.height;
        const layout = chooseSheetLayout(tileW, tileH, sheetW, sheetH, outerMarginPx);

        const canvas = document.createElement("canvas");
        canvas.width = sheetW;
        canvas.height = sheetH;
        const ctx = canvas.getContext("2d", { alpha: false });
        if (!ctx) {
          throw new Error("Canvas-Kontext für Druckbogen konnte nicht erstellt werden.");
        }
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, sheetW, sheetH);

        for (let row = 0; row < layout.rows; row += 1) {
          for (let col = 0; col < layout.cols; col += 1) {
            const x = layout.offsetX + (col * tileW);
            const y = layout.offsetY + (row * tileH);
            ctx.drawImage(tileCanvas, x, y, tileW, tileH);
          }
        }

        if (model.includeCrop) {
          drawSheetGridMarks(ctx, layout, layout.offsetX, layout.offsetY, tileW, tileH, dpi / 25.4);
        }

        return {
          canvas: canvas,
          layout: layout,
          a4wMm: a4wMm,
          a4hMm: a4hMm,
          model: tileModel
        };
      }

      async function exportSheetPdf(model) {
        const a4wMm = 210;
        const a4hMm = 297;
        const outerMarginMm = 4;
        const tileModel = Object.assign({}, model, {
          includeCrop: false,
          bgColor: "#ffffff"
        });
        const tileDims = cardDimensionsMm(tileModel);
        const tileWmm = tileDims.widthMm;
        const tileHmm = tileDims.heightMm;
        const layoutMm = chooseSheetLayout(tileWmm, tileHmm, a4wMm, a4hMm, outerMarginMm);
        const base = buildExportBaseName(tileModel);
        const file = base.replace(/^visitenkarte_/, "visitenkarten_") + "_druckbogen-a4_" + layoutMm.count + "x.pdf";

        try {
          await ensureVectorPdfLibs();
          const outlineFonts = await ensureTitilliumOutlineFonts();
          const JsPdf = window.jspdf.jsPDF;
          const doc = new JsPdf({
            orientation: "portrait",
            unit: "mm",
            format: "a4",
            compress: true,
            putOnlyUsedFonts: true,
            precision: 12
          });
          const cardSvgMarkup = buildSvg(tileModel, false, {
            textAsPaths: true,
            outlineFonts: outlineFonts
          });
          const parsed = new DOMParser().parseFromString(cardSvgMarkup, "image/svg+xml");
          const cardSvgRoot = parsed.documentElement;
          if (!cardSvgRoot || cardSvgRoot.nodeName.toLowerCase() !== "svg") {
            throw new Error("SVG für Druckbogen konnte nicht gelesen werden.");
          }

          for (let row = 0; row < layoutMm.rows; row += 1) {
            for (let col = 0; col < layoutMm.cols; col += 1) {
              const x = layoutMm.offsetX + (col * tileWmm);
              const y = layoutMm.offsetY + (row * tileHmm);
              await doc.svg(cardSvgRoot.cloneNode(true), {
                x: x,
                y: y,
                width: tileWmm,
                height: tileHmm
              });
            }
          }

          if (model.includeCrop) {
            drawSheetGridMarksPdf(doc, layoutMm, layoutMm.offsetX, layoutMm.offsetY, tileWmm, tileHmm);
          }

          const vectorBlob = doc.output("blob");
          if (!vectorBlob || !vectorBlob.size) {
            throw new Error("Vektor-Druckbogen leer.");
          }
          downloadBlob(vectorBlob, file);
          return;
        } catch (err) {
          console.warn("Vektor-Druckbogen fehlgeschlagen, fallback auf Raster-PDF.", err);
        }

        const dpi = 300;
        const sheet = await renderSheetCanvas(model, dpi);
        const jpegUrl = sheet.canvas.toDataURL("image/jpeg", 0.96);
        const jpegBytes = base64ToUint8Array((jpegUrl.split(",")[1] || ""));
        const pdfBlob = buildPdfBlobFromJpeg(
          jpegBytes,
          sheet.canvas.width,
          sheet.canvas.height,
          mmToPt(sheet.a4wMm),
          mmToPt(sheet.a4hMm)
        );
        downloadBlob(pdfBlob, file);
      }

      function fitPreviewCard() {
        if (!stageEl || !previewCard || !previewZoom) {
          return;
        }
        previewZoom.style.transform = "scale(1)";
        const stageRect = stageEl.getBoundingClientRect();
        const cardW = previewCard.offsetWidth || 1;
        const cardH = previewCard.offsetHeight || 1;
        const maxW = Math.max(1, stageRect.width - 10);
        const maxH = Math.max(1, stageRect.height - 10);
        const scale = Math.min(1, Math.min(maxW / cardW, maxH / cardH));
        previewZoom.style.transform = "scale(" + scale.toFixed(3) + ")";
      }

      function renderAll() {
        const model = collectModel();
        syncCardCssVars(model);
        syncOrgColorInfo();
        renderCard(previewCard, model);
        renderCard(printCard, model);
        fitPreviewCard();

        const org = ORG_DEFS[model.schema];
        const line1 = document.getElementById("metaLine1");
        if (line1) {
          const dims = cardDimensionsMm(model);
          const dict = uiDict();
          line1.textContent = dims.widthMm + " × " + dims.heightMm + " mm · " + (org ? orgNameForUi(org) : dict.meta_fallback_unit);
        }

        if (model.includeCrop) {
          printArtboard.classList.add("with-crop");
        } else {
          printArtboard.classList.remove("with-crop");
        }
      }

      function wireEvents() {
        Object.keys(refs).forEach(function (key) {
          const el = refs[key];
          if (!el) {
            return;
          }

          const update = function () {
            if (key === "orgCategory") {
              populateOrgOptions();
              syncFormatControl(refs.schema.value);
              applySchemaPreset(false);
              renderAll();
              return;
            }
            if (key === "schema") {
              syncFormatControl(refs.schema.value);
              applySchemaPreset(false);
            }
            renderAll();
          };

          if (el.tagName === "SELECT" || el.type === "checkbox") {
            el.addEventListener("change", update);
          } else {
            el.addEventListener("input", update);
          }
        });

        document.getElementById("btnSvg").addEventListener("click", function () {
          const model = collectModel();
          ensureExportAuthorized(uiDict().btn_svg, "svg", model, async function () {
            await withExportState("btnSvg", "SVG …", async function () {
              let svg = "";
              try {
                const outlineFonts = await ensureTitilliumOutlineFonts();
                svg = buildSvg(model, model.includeCrop, {
                  textAsPaths: true,
                  outlineFonts: outlineFonts
                });
              } catch (err) {
                console.warn("Pfad-SVG nicht verfügbar, fallback auf Text-SVG.", err);
                svg = buildSvg(model, model.includeCrop);
              }
              const name = buildExportBaseName(model) + ".svg";
              downloadBlob(new Blob([svg], { type: "image/svg+xml" }), name);
            });
          });
        });

        document.getElementById("btnPng").addEventListener("click", function () {
          const model = collectModel();
          ensureExportAuthorized(uiDict().btn_png, "png", model, async function () {
            await withExportState("btnPng", "PNG …", async function () {
              await exportPng(model, 600);
            });
          });
        });

        document.getElementById("btnPdf").addEventListener("click", function () {
          const model = collectModel();
          ensureExportAuthorized(uiDict().btn_pdf, "pdf", model, async function () {
            await withExportState("btnPdf", "PDF …", async function () {
              await exportPdf(model);
            });
          });
        });

        document.getElementById("btnSheetPdf").addEventListener("click", function () {
          const model = collectModel();
          ensureExportAuthorized(uiDict().btn_sheet, "sheet_pdf", model, async function () {
            await withExportState("btnSheetPdf", currentUiLang === "en" ? "Sheet …" : "Bogen …", async function () {
              await exportSheetPdf(model);
            });
          });
        });

        if (emailGateCancel) {
          emailGateCancel.addEventListener("click", function () {
            closeEmailGate();
          });
        }

        if (emailGateAddress) {
          emailGateAddress.addEventListener("input", function () {
            emailGateError.textContent = "";
          });
        }

        if (emailGateForm) {
          emailGateForm.addEventListener("submit", async function (event) {
            event.preventDefault();
            if (!pendingEmailRequest) {
              closeEmailGate();
              return;
            }
            const address = String(emailGateAddress.value || "").trim();
            if (!isGoetheanumEmail(address)) {
              emailGateError.textContent = uiDict().email_gate_invalid;
              return;
            }
            if (emailGateSubmit) {
              emailGateSubmit.disabled = true;
              emailGateSubmit.textContent = uiDict().email_gate_requesting;
            }
            emailGateError.textContent = "";
            try {
              await sendEmailExportRequest({
                recipientEmail: address,
                exportKind: pendingEmailRequest.kind,
                model: pendingEmailRequest.model,
                requestedAt: new Date().toISOString(),
                source: "visitenkarten"
              });
              try {
                localStorage.setItem(EMAIL_TARGET_STORAGE_KEY, address);
              } catch (err) {
                // no-op
              }
              closeEmailGate();
              alert(uiDict().email_gate_success);
            } catch (err) {
              emailGateError.textContent = err && err.message ? err.message : "Request failed.";
              if (emailGateSubmit) {
                emailGateSubmit.disabled = false;
                emailGateSubmit.textContent = uiDict().email_gate_submit;
              }
            }
          });
        }

        if (emailGate) {
          emailGate.addEventListener("click", function (event) {
            if (event.target === emailGate) {
              closeEmailGate();
            }
          });
        }

        document.addEventListener("keydown", function (event) {
          if (event.key === "Escape" && emailGate && emailGate.classList.contains("open")) {
            closeEmailGate();
          }
        });

        if (uiLangToggle) {
          uiLangToggle.addEventListener("click", function (event) {
            const target = event.target && event.target.closest("button[data-uilang]");
            if (!target) {
              return;
            }
            applyUiLanguage(target.getAttribute("data-uilang"));
          });
        }

        window.addEventListener("resize", function () {
          fitPreviewCard();
        });

        if (ownerModeSwitch) {
          ownerModeSwitch.addEventListener("click", function () {
            handleOwnerTap();
          });
        }
      }

      function init() {
        let startLang = "de";
        let storedOwnerMode = "0";
        try {
          const stored = localStorage.getItem("vk_ui_lang");
          if (stored === "en" || stored === "de") {
            startLang = stored;
          }
          storedOwnerMode = localStorage.getItem(OWNER_MODE_STORAGE_KEY) || "0";
        } catch (err) {
          startLang = "de";
          storedOwnerMode = "0";
        }
        ownerModeEnabled = storedOwnerMode === "1";
        applyUiLanguage(startLang);

        refs.orgCategory.value = "hochschule";
        populateOrgOptions("aas");
        syncFormatControl("aas");
        applySchemaPreset(true);
        wireEvents();
        renderAll();
      }

      init();
    })();
  </script>
</body>
</html>
